/*
 @overview RSVP - a tiny implementation of Promises/A+.
 @copyright Copyright (c) 2014 Yehuda Katz, Tom Dale, Stefan Penner and contributors
 @license   Licensed under MIT license
            See https://raw.githubusercontent.com/tildeio/rsvp.js/master/LICENSE
 @version   3.1.0
*/
(function(){function a(a){return"function"===typeof a}function b(){}function c(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1}function d(a){var b=a._promiseCallbacks;b||(b=a._promiseCallbacks={});return b}function e(a,b){if("onerror"===a)q.on("error",b);else if(2===arguments.length)q[a]=b;else return q[a]}function f(){setTimeout(function(){for(var a,b=0;b<K.length;b++){a=K[b];var c=a.payload;c.guid=c.key+c.id;c.childGuid=c.key+c.childId;c.error&&(c.stack=c.error.stack);q.trigger(a.name,
a.payload)}K.length=0},50)}function g(){}function h(a,b,c,d){try{a.call(b,c,d)}catch(fa){return fa}}function k(a,b,c){q.async(function(a){var d=!1,e=h(c,b,function(c){d||(d=!0,b!==c?p(a,c):l(a,c))},function(b){d||(d=!0,n(a,b))},"Settle: "+(a._label||" unknown promise"));!d&&e&&(d=!0,n(a,e))},a)}function m(a,b){1===b._state?l(a,b._result):2===b._state?(b._onError=null,n(a,b._result)):y(b,void 0,function(c){b!==c?p(a,c):l(a,c)},function(b){n(a,b)})}function p(b,c){if(b===c)l(b,c);else if("function"===
typeof c||"object"===typeof c&&null!==c)if(c.constructor===b.constructor)m(b,c);else{var d;try{d=c.then}catch(E){L.error=E,d=L}d===L?n(b,L.error):void 0===d?l(b,c):a(d)?k(b,c,d):l(b,c)}else l(b,c)}function u(a){a._onError&&a._onError(a._result);M(a)}function l(a,b){void 0===a._state&&(a._result=b,a._state=1,0===a._subscribers.length?q.instrument&&F("fulfilled",a):q.async(M,a))}function n(a,b){void 0===a._state&&(a._state=2,a._result=b,q.async(u,a))}function y(a,b,c,d){var e=a._subscribers,f=e.length;
a._onError=null;e[f]=b;e[f+1]=c;e[f+2]=d;0===f&&a._state&&q.async(M,a)}function M(a){var b=a._subscribers,c=a._state;q.instrument&&F(1===c?"fulfilled":"rejected",a);if(0!==b.length){for(var d,e,f=a._result,g=0;g<b.length;g+=3)d=b[g],e=b[g+c],d?S(c,d,e,f):e(f);a._subscribers.length=0}}function T(){this.error=null}function S(b,c,d,e){var f=a(d),g,R,J,h;if(f){try{g=d(e)}catch(ga){N.error=ga,g=N}g===N?(h=!0,R=g.error,g=null):J=!0;if(c===g){n(c,new TypeError("A promises callback cannot return that same promise."));
return}}else g=e,J=!0;void 0===c._state&&(f&&J?p(c,g):h?n(c,R):1===b?l(c,g):2===b&&n(c,g))}function ha(a,b){var c=!1;try{b(function(b){c||(c=!0,p(a,b))},function(b){c||(c=!0,n(a,b))})}catch(E){n(a,E)}}function U(a,b,c){return 1===a?{state:"fulfilled",value:c}:{state:"rejected",reason:c}}function t(a,b,c,d){this._instanceConstructor=a;this.promise=new a(g,d);this._abortOnReject=c;this._validateInput(b)?(this._input=b,this._remaining=this.length=b.length,this._init(),0===this.length?l(this.promise,
this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&l(this.promise,this._result))):n(this.promise,this._validationError())}function v(b,c){this._id=ia++;this._label=c;this._result=this._state=void 0;this._subscribers=[];q.instrument&&F("created",this);if(g!==b){if(!a(b))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof v))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");
ha(this,b)}}function G(a,b,c){this._superConstructor(a,b,!1,c)}function ja(){var a=process.nextTick,b=process.versions.node.match(/^(?:(\d+)\.)?(?:(\d+)\.)?(\*|\d+)$/);Array.isArray(b)&&"0"===b[1]&&"10"===b[2]&&(a=setImmediate);return function(){a(H)}}function ka(){return function(){V(H)}}function la(){var a=0,b=new W(H),c=document.createTextNode("");b.observe(c,{characterData:!0});return function(){c.data=a=++a%2}}function ma(){var a=new MessageChannel;a.port1.onmessage=H;return function(){a.port2.postMessage(0)}}
function X(){return function(){setTimeout(H,1)}}function H(){for(var a=0;a<A;a+=2)(0,B[a])(B[a+1]),B[a]=void 0,B[a+1]=void 0;A=0}function na(){try{var a=require("vertx");V=a.runOnLoop||a.runOnContext;return ka()}catch(J){return X()}}function w(a,b,c){this._superConstructor(a,b,!0,c)}function I(a,b,c){this._superConstructor(a,b,!1,c)}function Y(){this.value=void 0}function Z(a,b,c){try{a.apply(b,c)}catch(E){return C.value=E,C}}function oa(a,b){return{then:function(c,d){return a.call(b,c,d)}}}function pa(a,
b,c,d){b=Z(c,d,b);b===C&&n(a,b.value);return a}function qa(a,b,c,d){return r.all(b).then(function(b){b=Z(c,d,b);b===C&&n(a,b.value);return a})}function aa(){q.on.apply(q,arguments)}var O=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},ba=Date.now||function(){return(new Date).getTime()},z=Object.create||function(a){if(1<arguments.length)throw Error("Second argument not supported");if("object"!==typeof a)throw new TypeError("Argument must be an object");
b.prototype=a;return new b},ca={mixin:function(a){a.on=this.on;a.off=this.off;a.trigger=this.trigger;a._promiseCallbacks=void 0;return a},on:function(a,b){if("function"!==typeof b)throw new TypeError("Callback must be a function");var e=d(this),f;(f=e[a])||(f=e[a]=[]);-1===c(f,b)&&f.push(b)},off:function(a,b){var e=d(this);b?(a=e[a],b=c(a,b),-1!==b&&a.splice(b,1)):e[a]=[]},trigger:function(a,b,c){var e;if(a=d(this)[a])for(var f=0;f<a.length;f++)e=a[f],e(b,c)}},q={instrument:!1};ca.mixin(q);var K=
[],F=function(a,b,c){1===K.push({name:a,payload:{key:b._guidKey,id:b._id,eventName:a,detail:b._result,childId:c&&c._id,label:b._label,timeStamp:ba(),error:q["instrument-with-stack"]?Error(b._label):null}})&&f()},L=new T,N=new T;t.prototype._validateInput=function(a){return O(a)};t.prototype._validationError=function(){return Error("Array Methods must be provided an Array")};t.prototype._init=function(){this._result=Array(this.length)};t.prototype._enumerate=function(){for(var a=this.length,b=this.promise,
c=this._input,d=0;void 0===b._state&&d<a;d++)this._eachEntry(c[d],d)};t.prototype._eachEntry=function(a,b){var c=this._instanceConstructor;"object"===typeof a&&null!==a?a.constructor===c&&void 0!==a._state?(a._onError=null,this._settledAt(a._state,b,a._result)):this._willSettleAt(c.resolve(a),b):(this._remaining--,this._result[b]=this._makeResult(1,b,a))};t.prototype._settledAt=function(a,b,c){var d=this.promise;void 0===d._state&&(this._remaining--,this._abortOnReject&&2===a?n(d,c):this._result[b]=
this._makeResult(a,b,c));0===this._remaining&&l(d,this._result)};t.prototype._makeResult=function(a,b,c){return c};t.prototype._willSettleAt=function(a,b){var c=this;y(a,void 0,function(a){c._settledAt(1,b,a)},function(a){c._settledAt(2,b,a)})};var x=function(a,b){if(a&&"object"===typeof a&&a.constructor===this)return a;b=new this(g,b);p(b,a);return b},D="rsvp_"+ba()+"-",ia=0,r=v;v.cast=x;v.all=function(a,b){return(new t(this,a,!0,b)).promise};v.race=function(a,b){function c(a){p(e,a)}function d(a){n(e,
a)}var e=new this(g,b);if(!O(a))return n(e,new TypeError("You must pass an array to race.")),e;b=a.length;for(var f=0;void 0===e._state&&f<b;f++)y(this.resolve(a[f]),void 0,c,d);return e};v.resolve=x;v.reject=function(a,b){b=new this(g,b);n(b,a);return b};v.prototype={constructor:v,_guidKey:D,_onError:function(a){var b=this;q.after(function(){b._onError&&q.trigger("error",a,b._label)})},then:function(a,b,c){var d=this._state;if(1===d&&!a||2===d&&!b)return q.instrument&&F("chained",this,this),this;
this._onError=null;var e=new this.constructor(g,c),f=this._result;q.instrument&&F("chained",this,e);if(d){var h=arguments[d-1];q.async(function(){S(d,e,h,f)})}else y(this,e,a,b);return e},"catch":function(a,b){return this.then(void 0,a,b)},"finally":function(a,b){var c=this.constructor;return this.then(function(b){return c.resolve(a()).then(function(){return b})},function(b){return c.resolve(a()).then(function(){throw b;})},b)}};G.prototype=z(t.prototype);G.prototype._superConstructor=t;G.prototype._makeResult=
U;G.prototype._validationError=function(){return Error("allSettled must be called with an array")};var A=0,V,D=(x="undefined"!==typeof window?window:void 0)||{},W=D.MutationObserver||D.WebKitMutationObserver,D="undefined"===typeof self&&"undefined"!==typeof process&&"[object process]"==={}.toString.call(process),ra="undefined"!==typeof Uint8ClampedArray&&"undefined"!==typeof importScripts&&"undefined"!==typeof MessageChannel,B=Array(1E3),da;da=D?ja():W?la():ra?ma():void 0===x&&"function"===typeof require?
na():X();w.prototype=z(t.prototype);w.prototype._superConstructor=t;w.prototype._init=function(){this._result={}};w.prototype._validateInput=function(a){return a&&"object"===typeof a};w.prototype._validationError=function(){return Error("Promise.hash must be called with an object")};w.prototype._enumerate=function(){var a=this.promise,b=this._input,c=[],d;for(d in b)void 0===a._state&&Object.prototype.hasOwnProperty.call(b,d)&&c.push({position:d,entry:b[d]});this._remaining=b=c.length;for(var e=0;void 0===
a._state&&e<b;e++)d=c[e],this._eachEntry(d.entry,d.position)};I.prototype=z(w.prototype);I.prototype._superConstructor=t;I.prototype._makeResult=U;I.prototype._validationError=function(){return Error("hashSettled must be called with an object")};var C=new Y,ea=new Y;if("object"===typeof self)z=self;else if("object"===typeof global)z=global;else throw Error("no global: `self` or `global` found");q.async=function(a,b){B[A]=a;B[A+1]=b;A+=2;2===A&&da()};q.after=function(a){setTimeout(a,0)};if("undefined"!==
typeof window&&"object"===typeof window.__PROMISE_INSTRUMENTATION__){x=window.__PROMISE_INSTRUMENTATION__;e("instrument",!0);for(var P in x)x.hasOwnProperty(P)&&aa(P,x[P])}var Q={race:function(a,b){return r.race(a,b)},Promise:r,allSettled:function(a,b){return(new G(r,a,b)).promise},hash:function(a,b){return(new w(r,a,b)).promise},hashSettled:function(a,b){return(new I(r,a,b)).promise},denodeify:function(a,b){var c=function(){for(var c=arguments.length,d=Array(c+1),e,f=!1,h=0;h<c;++h){e=arguments[h];
if(!f){if(e&&"object"===typeof e){var k;if(e.constructor===r)k=!0;else try{k=e.then}catch(sa){C.value=sa,k=C}f=k}else f=!1;if(f===ea)return c=new r(g),n(c,ea.value),c;f&&!0!==f&&(e=oa(f,e))}d[h]=e}var m=new r(g);d[c]=function(a,c){if(a)n(m,a);else if(void 0===b)p(m,c);else if(!0===b){for(var d=arguments,e=d.length,f=Array(e-1),g=1;g<e;g++)f[g-1]=d[g];p(m,f)}else if(O(b)){for(var f=arguments,d={},g=f.length,e=Array(g),h=0;h<g;h++)e[h]=f[h];for(g=0;g<b.length;g++)f=b[g],d[f]=e[g+1];p(m,d)}else p(m,
c)};return f?qa(m,d,a,this):pa(m,d,a,this)};c.__proto__=a;return c},on:aa,off:function(){q.off.apply(q,arguments)},map:function(b,c,d){return r.all(b,d).then(function(b){if(!a(c))throw new TypeError("You must pass a function as map's second argument.");for(var e=b.length,f=Array(e),g=0;g<e;g++)f[g]=c(b[g]);return r.all(f,d)})},filter:function(b,c,d){return r.all(b,d).then(function(b){if(!a(c))throw new TypeError("You must pass a function as filter's second argument.");for(var e=b.length,f=Array(e),
g=0;g<e;g++)f[g]=c(b[g]);return r.all(f,d).then(function(a){for(var c=Array(e),d=0,f=0;f<e;f++)a[f]&&(c[d]=b[f],d++);c.length=d;return c})})},resolve:function(a,b){return r.resolve(a,b)},reject:function(a,b){return r.reject(a,b)},all:function(a,b){return r.all(a,b)},rethrow:function(a){setTimeout(function(){throw a;});throw a;},defer:function(a){var b={};b.promise=new r(function(a,c){b.resolve=a;b.reject=c},a);return b},EventTarget:ca,configure:e,async:function(a,b){q.async(a,b)}};"function"===typeof define&&
define.amd?define(function(){return Q}):"undefined"!==typeof module&&module.exports?module.exports=Q:"undefined"!==typeof z&&(z.RSVP=Q)}).call(this);"use strict";var EPUBJS=EPUBJS||{};EPUBJS.VERSION="0.2.14";EPUBJS.plugins=EPUBJS.plugins||{};EPUBJS.filePath=EPUBJS.filePath||"/epubjs/";EPUBJS.Render={};
(function(a){var b=a.ePub=function(a,b){var c;"undefined"!=typeof a&&("string"===typeof a||a instanceof ArrayBuffer)&&(b&&"object"===typeof b?(c=b,c.bookPath=a):c={bookPath:a});!a||"object"!==typeof a||a instanceof ArrayBuffer||(c=a);return new EPUBJS.Book(c)};"function"===typeof define&&define.amd?define(["rsvp","jszip","localforage"],function(a,d,e){return b}):"undefined"!=typeof module&&module.exports&&(global.RSVP=require("rsvp"),global.JSZip=require("jszip"),global.localForage=require("localforage"),
module.exports=b)})(window);
EPUBJS.Book=function(a){this.settings=EPUBJS.core.defaults(a||{},{bookPath:void 0,bookKey:void 0,packageUrl:void 0,storage:!1,fromStorage:!1,saved:!1,online:!0,contained:!1,width:void 0,height:void 0,layoutOveride:void 0,orientation:void 0,minSpreadWidth:768,gap:"auto",version:1,restore:!1,reload:!1,goto:!1,styles:{},headTags:{},withCredentials:!1,render_method:"Iframe"});this.settings.EPUBJSVERSION=EPUBJS.VERSION;this.spinePos=0;this.stored=!1;this.online=this.settings.online||navigator.onLine;this.networkListeners();
this.ready={manifest:new RSVP.defer,spine:new RSVP.defer,metadata:new RSVP.defer,cover:new RSVP.defer,toc:new RSVP.defer,pageList:new RSVP.defer};this.readyPromises=[this.ready.manifest.promise,this.ready.spine.promise,this.ready.metadata.promise,this.ready.cover.promise,this.ready.toc.promise];this.pageList=[];this.pagination=new EPUBJS.Pagination;this.pageListReady=this.ready.pageList.promise;this.ready.all=RSVP.all(this.readyPromises);this.ready.all.then(this._ready.bind(this));this.isRendered=
!1;this._q=EPUBJS.core.queue(this);this._rendering=!1;this._displayQ=EPUBJS.core.queue(this);this._moving=!1;this._gotoQ=EPUBJS.core.queue(this);this.renderer=new EPUBJS.Renderer(this.settings.render_method);this.renderer.setMinSpreadWidth(this.settings.minSpreadWidth);this.renderer.setGap(this.settings.gap);this.listenToRenderer(this.renderer);this.defer_opened=new RSVP.defer;this.opened=this.defer_opened.promise;this.store=!1;!1!==this.settings.storage&&this.fromStorage(!0);("string"===typeof this.settings.bookPath||
this.settings.bookPath instanceof ArrayBuffer)&&this.open(this.settings.bookPath,this.settings.reload);window.addEventListener("beforeunload",this.unload.bind(this),!1)};
EPUBJS.Book.prototype.open=function(a,b){var c=this,d=new RSVP.defer;this.settings.bookPath=a;this.settings.contained||this.isContained(a)?(this.settings.contained=this.contained=!0,this.bookUrl="",a=this.unarchive(a).then(function(){return c.loadPackage()})):(this.bookUrl=this.urlFrom(a),a=this.loadPackage());this.settings.restore&&!b&&localStorage?a.then(function(a){var b=c.packageIdentifier(a);c.restore(b)||c.unpack(a);d.resolve();c.defer_opened.resolve()}):a.then(function(a){c.unpack(a);d.resolve();
c.defer_opened.resolve()});this._registerReplacements(this.renderer);return d.promise};
EPUBJS.Book.prototype.loadPackage=function(a){var b=this,c=new EPUBJS.Parser,d=a||"META-INF/container.xml";a=this.settings.packageUrl?b.loadXml(b.settings.packageUrl):b.loadXml(b.bookUrl+d).then(function(a){return c.container(a)}).then(function(a){b.settings.contentsPath=b.bookUrl+a.basePath;b.settings.packageUrl=b.bookUrl+a.packagePath;b.settings.encoding=a.encoding;return b.loadXml(b.settings.packageUrl)});a.catch(function(a){console.error("Could not load book at: "+d);b.trigger("book:loadFailed",
d)});return a};EPUBJS.Book.prototype.packageIdentifier=function(a){return(new EPUBJS.Parser).identifier(a)};
EPUBJS.Book.prototype.unpack=function(a){var b=this,c=new EPUBJS.Parser;b.contents=c.packageContents(a,b.settings.contentsPath);b.manifest=b.contents.manifest;b.spine=b.contents.spine;b.spineIndexByURL=b.contents.spineIndexByURL;b.metadata=b.contents.metadata;b.settings.bookKey||(b.settings.bookKey=b.generateBookKey(b.metadata.identifier));b.globalLayoutProperties=b.parseLayoutProperties(b.metadata);b.contents.coverPath&&(b.cover=b.contents.cover=b.settings.contentsPath+b.contents.coverPath);b.spineNodeIndex=
b.contents.spineNodeIndex;b.ready.manifest.resolve(b.contents.manifest);b.ready.spine.resolve(b.contents.spine);b.ready.metadata.resolve(b.contents.metadata);b.ready.cover.resolve(b.contents.cover);b.locations=new EPUBJS.Locations(b.spine,b.store,b.settings.withCredentials);b.contents.navPath&&!b.contents.tocPath?(b.settings.navUrl=b.settings.contentsPath+b.contents.navPath,b.loadXml(b.settings.navUrl).then(function(a){return c.nav(a,b.spineIndexByURL,b.spine)}).then(function(a){b.toc=b.contents.toc=
a;b.ready.toc.resolve(b.contents.toc)},function(a){b.ready.toc.resolve(!1)}),b.loadXml(b.settings.navUrl).then(function(a){return c.pageList(a,b.spineIndexByURL,b.spine)}).then(function(a){var c=new EPUBJS.EpubCFI,d=0;0!==a.length&&(b.pageList=b.contents.pageList=a,b.pageList.forEach(function(a){a.cfi||(d+=1,c.generateCfiFromHref(a.href,b).then(function(c){a.cfi=c;a.packageUrl=b.settings.packageUrl;--d;0===d&&(b.pagination.process(b.pageList),b.ready.pageList.resolve(b.pageList))}))}),d||(b.pagination.process(b.pageList),
b.ready.pageList.resolve(b.pageList)))},function(a){b.ready.pageList.resolve([])})):b.contents.tocPath?(b.settings.tocUrl=b.settings.contentsPath+b.contents.tocPath,b.loadXml(b.settings.tocUrl).then(function(a){return c.toc(a,b.spineIndexByURL,b.spine)},function(a){console.error(a)}).then(function(a){b.toc=b.contents.toc=a;b.ready.toc.resolve(b.contents.toc)},function(a){b.ready.toc.resolve(!1)})):b.ready.toc.resolve(!1)};
EPUBJS.Book.prototype.createHiddenRender=function(a,b,c){var d=this.element.getBoundingClientRect();b=b||this.settings.width||d.width;c=c||this.settings.height||d.height;var e;a.setMinSpreadWidth(this.settings.minSpreadWidth);a.setGap(this.settings.gap);this._registerReplacements(a);this.settings.forceSingle&&a.forceSingle(!0);d=document.createElement("div");d.style.visibility="hidden";d.style.overflow="hidden";d.style.width="0";d.style.height="0";this.element.appendChild(d);e=document.createElement("div");
e.style.visibility="hidden";e.style.overflow="hidden";e.style.width=b+"px";e.style.height=c+"px";d.appendChild(e);a.initialize(e,this.settings.width,this.settings.height);return d};
EPUBJS.Book.prototype.generatePageList=function(a,b,c){var d=[],e=new EPUBJS.Renderer(this.settings.render_method,!1),f=this.createHiddenRender(e,a,b),g=new RSVP.defer,h=-1,k=this.spine.length,m=0,p=function(a){var b=h+1,g=a||new RSVP.defer;if(b>=k)g.resolve();else{if(c&&c.cancelled){e.remove();this.element.removeChild(f);g.reject(Error("User cancelled"));return}h=b;a=new EPUBJS.Chapter(this.spine[h],this.store);e.displayChapter(a,this.globalLayoutProperties).then(function(a){e.pageMap.forEach(function(a){m+=
1;d.push({cfi:a.start,page:m})});0<e.pageMap.length%2&&e.spreads&&(m+=1,d.push({cfi:e.pageMap[e.pageMap.length-1].end,page:m}));setTimeout(function(){p(g)},1)})}return g.promise}.bind(this);p().then(function(){e.remove();this.element.removeChild(f);g.resolve(d)}.bind(this),function(a){g.reject(a)});return g.promise};
EPUBJS.Book.prototype.generatePagination=function(a,b,c){var d=this,e=new RSVP.defer;this.ready.spine.promise.then(function(){d.generatePageList(a,b,c).then(function(a){d.pageList=d.contents.pageList=a;d.pagination.process(a);d.ready.pageList.resolve(d.pageList);e.resolve(d.pageList)},function(a){e.reject(a)})});return e.promise};
EPUBJS.Book.prototype.loadPagination=function(a){(a="string"===typeof a?JSON.parse(a):a)&&a.length&&(this.pageList=a,this.pagination.process(this.pageList),this.ready.pageList.resolve(this.pageList));return this.pageList};EPUBJS.Book.prototype.getPageList=function(){return this.ready.pageList.promise};EPUBJS.Book.prototype.getMetadata=function(){return this.ready.metadata.promise};EPUBJS.Book.prototype.getToc=function(){return this.ready.toc.promise};
EPUBJS.Book.prototype.networkListeners=function(){var a=this;window.addEventListener("offline",function(b){a.online=!1;a.settings.storage&&a.fromStorage(!0);a.trigger("book:offline")},!1);window.addEventListener("online",function(b){a.online=!0;a.settings.storage&&a.fromStorage(!1);a.trigger("book:online")},!1)};
EPUBJS.Book.prototype.listenToRenderer=function(a){var b=this;a.Events.forEach(function(c){a.on(c,function(a){b.trigger(c,a)})});a.on("renderer:visibleRangeChanged",function(a){var b,c,f=[];0<this.pageList.length&&(b=this.pagination.pageFromCfi(a.start),c=this.pagination.percentageFromPage(b),f.push(b),a.end&&(a=this.pagination.pageFromCfi(a.end),f.push(a)),this.trigger("book:pageChanged",{anchorPage:b,percentage:c,pageRange:f}))}.bind(this));a.on("render:loaded",this.loadChange.bind(this))};
EPUBJS.Book.prototype.loadChange=function(a){a=EPUBJS.core.uri(a);var b=EPUBJS.core.uri(this.currentChapter.absolute);a.path!=b.path?(console.warn("Miss Match",a.path,this.currentChapter.absolute),a=this.spineIndexByURL[a.filename],this.currentChapter=a=new EPUBJS.Chapter(this.spine[a],this.store),this.renderer.currentChapter=a,this.renderer.afterLoad(this.renderer.render.docEl),this.renderer.beforeDisplay(function(){this.renderer.afterDisplay()}.bind(this))):this._rendering||this.renderer.reformat()};
EPUBJS.Book.prototype.unlistenToRenderer=function(a){a.Events.forEach(function(b){a.off(b)})};EPUBJS.Book.prototype.coverUrl=function(){var a=this.ready.cover.promise.then(function(a){return this.settings.fromStorage?this.store.getUrl(this.contents.cover):this.settings.contained?this.zip.getUrl(this.contents.cover):this.contents.cover}.bind(this));a.then(function(a){this.cover=a}.bind(this));return a};
EPUBJS.Book.prototype.loadXml=function(a){return this.settings.fromStorage?this.store.getXml(a,this.settings.encoding):this.settings.contained?this.zip.getXml(a,this.settings.encoding):EPUBJS.core.request(a,"xml",this.settings.withCredentials)};
EPUBJS.Book.prototype.urlFrom=function(a){a=EPUBJS.core.uri(a);var b=a.protocol,c="/"==a.path[0],d=window.location,e=d.origin||d.protocol+"//"+d.host,f=document.getElementsByTagName("base"),g;f.length&&(g=f[0].href);if(a.protocol)return a.origin+a.path;if(!b&&c)return(g||e)+a.path;if(!b&&!c)return EPUBJS.core.resolveUrl(g||d.pathname,a.path)};EPUBJS.Book.prototype.unarchive=function(a){this.store=this.zip=new EPUBJS.Unarchiver;return this.zip.open(a)};
EPUBJS.Book.prototype.isContained=function(a){if(a instanceof ArrayBuffer)return!0;a=EPUBJS.core.uri(a);return!a.extension||"epub"!=a.extension&&"zip"!=a.extension?!1:!0};EPUBJS.Book.prototype.isSaved=function(a){if(!localStorage)return!1;a=localStorage.getItem(a);return localStorage&&null!==a?!0:!1};EPUBJS.Book.prototype.generateBookKey=function(a){return"epubjs:"+EPUBJS.VERSION+":"+window.location.host+":"+a};
EPUBJS.Book.prototype.saveContents=function(){if(!localStorage)return!1;localStorage.setItem(this.settings.bookKey,JSON.stringify(this.contents))};EPUBJS.Book.prototype.removeSavedContents=function(){if(!localStorage)return!1;localStorage.removeItem(this.settings.bookKey)};
EPUBJS.Book.prototype.renderTo=function(a){var b=this;if(EPUBJS.core.isElement(a))this.element=a;else if("string"==typeof a)this.element=EPUBJS.core.getEl(a);else{console.error("Not an Element");return}return this.opened.then(function(){b.renderer.initialize(b.element,b.settings.width,b.settings.height);b.metadata.direction&&b.renderer.setDirection(b.metadata.direction);b._rendered();return b.startDisplay()})};
EPUBJS.Book.prototype.startDisplay=function(){return this.settings.goto?this.goto(this.settings.goto):this.settings.previousLocationCfi?this.gotoCfi(this.settings.previousLocationCfi):this.displayChapter(this.spinePos)};
EPUBJS.Book.prototype.restore=function(a){var b="manifest spine metadata cover toc spineNodeIndex spineIndexByURL globalLayoutProperties".split(" "),c=!1;a=this.generateBookKey(a);var d=localStorage.getItem(a),e=b.length,f;this.settings.clearSaved&&(c=!0);if(!c&&"undefined"!=d&&null!==d)for(this.contents=JSON.parse(d),f=0;f<e;f++){var g=b[f];if(!this.contents[g]){c=!0;break}this[g]=this.contents[g]}return!c&&d&&this.contents&&this.settings.contentsPath?(this.settings.bookKey=a,this.ready.manifest.resolve(this.manifest),
this.ready.spine.resolve(this.spine),this.ready.metadata.resolve(this.metadata),this.ready.cover.resolve(this.cover),this.ready.toc.resolve(this.toc),!0):!1};
EPUBJS.Book.prototype.displayChapter=function(a,b,c){var d=this,e,f,g,h=c||new RSVP.defer,k;if(!this.isRendered)return this._q.enqueue("displayChapter",arguments),h.reject({message:"Rendering",stack:Error().stack}),h.promise;if(this._rendering||this.renderer._moving)return this._displayQ.enqueue("displayChapter",[a,b,h]),h.promise;EPUBJS.core.isNumber(a)?g=a:(f=new EPUBJS.EpubCFI(a),g=f.spinePos);if(0>g||g>=this.spine.length)console.warn("Not A Valid Location"),g=0,f=b=!1;k=new EPUBJS.Chapter(this.spine[g],
this.store);this._rendering=!0;this._needsAssetReplacement()&&k.registerHook("beforeChapterRender",[EPUBJS.replace.head,EPUBJS.replace.resources,EPUBJS.replace.svg],!0);d.currentChapter=k;e=d.renderer.displayChapter(k,this.globalLayoutProperties);f?d.renderer.gotoCfi(f):b&&d.renderer.lastPage();e.then(function(a){d.spinePos=g;h.resolve(d.renderer);!1===d.settings.fromStorage&&!1===d.settings.contained&&d.preloadNextChapter();d._rendering=!1;d._displayQ.dequeue();0===d._displayQ.length()&&d._gotoQ.dequeue()},
function(a){console.error("Could not load Chapter: "+k.absolute,a);d.trigger("book:chapterLoadFailed",k.absolute);d._rendering=!1;h.reject(a)});return h.promise};EPUBJS.Book.prototype.nextPage=function(a){a=a||new RSVP.defer;if(!this.isRendered)return this._q.enqueue("nextPage",[a]),a.promise;if(!this.renderer.nextPage())return this.nextChapter(a);a.resolve(!0);return a.promise};
EPUBJS.Book.prototype.prevPage=function(a){a=a||new RSVP.defer;if(!this.isRendered)return this._q.enqueue("prevPage",[a]),a.promise;if(!this.renderer.prevPage())return this.prevChapter(a);a.resolve(!0);return a.promise};
EPUBJS.Book.prototype.nextChapter=function(a){a=a||new RSVP.defer;if(this.spinePos<this.spine.length-1){for(var b=this.spinePos+1;this.spine[b]&&this.spine[b].linear&&"no"==this.spine[b].linear;)b++;if(b<this.spine.length)return this.displayChapter(b,!1,a)}this.trigger("book:atEnd");a.resolve(!0);return a.promise};
EPUBJS.Book.prototype.prevChapter=function(a){a=a||new RSVP.defer;if(0<this.spinePos){for(var b=this.spinePos-1;this.spine[b]&&this.spine[b].linear&&"no"==this.spine[b].linear;)b--;if(0<=b)return this.displayChapter(b,!0,a)}this.trigger("book:atStart");a.resolve(!0);return a.promise};EPUBJS.Book.prototype.getCurrentLocationCfi=function(){return this.isRendered?this.renderer.currentLocationCfi:!1};
EPUBJS.Book.prototype.goto=function(a){return 0===a.indexOf("epubcfi(")?this.gotoCfi(a):a.indexOf("%")===a.length-1?this.gotoPercentage(parseInt(a.substring(0,a.length-1))/100):"number"===typeof a||!1===isNaN(a)?this.gotoPage(a):this.gotoHref(a)};
EPUBJS.Book.prototype.gotoCfi=function(a,b){var c,d,e,f=b||new RSVP.defer;if(!this.isRendered)return console.warn("Not yet Rendered"),this.settings.previousLocationCfi=a,!1;if(this._moving||this._rendering)return console.warn("Renderer is moving"),this._gotoQ.enqueue("gotoCfi",[a,f]),!1;c=new EPUBJS.EpubCFI(a);d=c.spinePos;if(-1==d)return!1;e=this.spine[d];b=f.promise;this._moving=!0;this.currentChapter&&this.spinePos===d?(this.renderer.gotoCfi(c),this._moving=!1,f.resolve(this.renderer.currentLocationCfi)):
(e&&-1!=d||(e=this.spine[0]),a=this.displayChapter(a),a.then(function(a){this._moving=!1;f.resolve(a.currentLocationCfi)}.bind(this),function(){this._moving=!1}.bind(this)));b.then(function(){this._gotoQ.dequeue()}.bind(this));return b};
EPUBJS.Book.prototype.gotoHref=function(a,b){var c,d=b||new RSVP.defer;if(!this.isRendered)return this.settings.goto=a,!1;if(this._moving||this._rendering)return this._gotoQ.enqueue("gotoHref",[a,d]),!1;b=a.split("#");a=b[0];c=b[1]||!1;b=-1==a.search("://")?a.replace(EPUBJS.core.uri(this.settings.contentsPath).path,""):a.replace(this.settings.contentsPath,"");b=this.spineIndexByURL[b];a||(b=this.currentChapter?this.currentChapter.spinePos:0);if("number"!=typeof b)return!1;if(this.currentChapter&&
b==this.currentChapter.spinePos)c?this.renderer.section(c):this.renderer.firstPage(),d.resolve(this.renderer.currentLocationCfi);else return this.displayChapter(b).then(function(){c&&this.renderer.section(c);d.resolve(this.renderer.currentLocationCfi)}.bind(this));d.promise.then(function(){this._gotoQ.dequeue()}.bind(this));return d.promise};EPUBJS.Book.prototype.gotoPage=function(a){a=this.pagination.cfiFromPage(a);return this.gotoCfi(a)};
EPUBJS.Book.prototype.gotoPercentage=function(a){a=this.pagination.pageFromPercentage(a);return this.gotoPage(a)};EPUBJS.Book.prototype.preloadNextChapter=function(){var a;a=this.spinePos+1;if(a>=this.spine.length)return!1;a=new EPUBJS.Chapter(this.spine[a]);EPUBJS.core.request(a.absolute)};EPUBJS.Book.prototype.storeOffline=function(){var a=this,b=EPUBJS.core.values(this.manifest);return this.store.put(b).then(function(){a.settings.stored=!0;a.trigger("book:stored")})};
EPUBJS.Book.prototype.availableOffline=function(){return 0<this.settings.stored?!0:!1};EPUBJS.Book.prototype.toStorage=function(){var a=this.settings.bookKey;this.store.isStored(a).then(function(b){return!0===b?this.settings.stored=!0:this.storeOffline().then(function(){this.store.token(a,!0)}.bind(this))}.bind(this))};
EPUBJS.Book.prototype.fromStorage=function(a){this.contained||this.settings.contained||(this.online&&this.opened.then(this.toStorage.bind(this)),this.store&&this.settings.fromStorage&&!1===a?(this.settings.fromStorage=!1,this.store.off("offline"),this.store=!1):this.settings.fromStorage||(this.store=new EPUBJS.Storage(this.settings.credentials),this.store.on("offline",function(a){a?(this.offline=!0,this.settings.fromStorage=!0,this.trigger("book:offline")):(this.offline=!1,this.settings.fromStorage=
!1,this.trigger("book:online"))}.bind(this))))};EPUBJS.Book.prototype.setStyle=function(a,b,c){if(!this.isRendered)return this._q.enqueue("setStyle",arguments);this.settings.styles[a]=b;this.renderer.setStyle(a,b,c);-1===["color","background","background-color"].indexOf(a)&&this.renderer.reformat()};EPUBJS.Book.prototype.removeStyle=function(a){if(!this.isRendered)return this._q.enqueue("removeStyle",arguments);this.renderer.removeStyle(a);this.renderer.reformat();delete this.settings.styles[a]};
EPUBJS.Book.prototype.addHeadTag=function(a,b){if(!this.isRendered)return this._q.enqueue("addHeadTag",arguments);this.settings.headTags[a]=b};EPUBJS.Book.prototype.useSpreads=function(a){console.warn("useSpreads is deprecated, use forceSingle or set a layoutOveride instead");!1===a?this.forceSingle(!0):this.forceSingle(!1)};EPUBJS.Book.prototype.forceSingle=function(a){a="undefined"===typeof a?!0:a;this.renderer.forceSingle(a);this.settings.forceSingle=a;this.isRendered&&this.renderer.reformat()};
EPUBJS.Book.prototype.setMinSpreadWidth=function(a){this.settings.minSpreadWidth=a;this.isRendered&&(this.renderer.setMinSpreadWidth(this.settings.minSpreadWidth),this.renderer.reformat())};EPUBJS.Book.prototype.setGap=function(a){this.settings.gap=a;this.isRendered&&(this.renderer.setGap(this.settings.gap),this.renderer.reformat())};
EPUBJS.Book.prototype.chapter=function(a){a=this.spineIndexByURL[a];var b;a&&(b=this.spine[a],b=new EPUBJS.Chapter(b,this.store,this.settings.withCredentials),b.load());return b};EPUBJS.Book.prototype.unload=function(){this.settings.restore&&localStorage&&this.saveContents();this.unlistenToRenderer(this.renderer);this.trigger("book:unload")};
EPUBJS.Book.prototype.destroy=function(){window.removeEventListener("beforeunload",this.unload);this.currentChapter&&this.currentChapter.unload();this.unload();this.renderer&&this.renderer.remove()};EPUBJS.Book.prototype._ready=function(){this.trigger("book:ready")};EPUBJS.Book.prototype._rendered=function(a){this.isRendered=!0;this.trigger("book:rendered");this._q.flush()};EPUBJS.Book.prototype.applyStyles=function(a,b){a.applyStyles(this.settings.styles);b()};
EPUBJS.Book.prototype.applyHeadTags=function(a,b){a.applyHeadTags(this.settings.headTags);b()};EPUBJS.Book.prototype._registerReplacements=function(a){a.registerHook("beforeChapterDisplay",this.applyStyles.bind(this,a),!0);a.registerHook("beforeChapterDisplay",this.applyHeadTags.bind(this,a),!0);a.registerHook("beforeChapterDisplay",EPUBJS.replace.hrefs.bind(this),!0)};EPUBJS.Book.prototype._needsAssetReplacement=function(){return this.settings.fromStorage?!0:this.settings.contained?!0:!1};
EPUBJS.Book.prototype.parseLayoutProperties=function(a){return{layout:this.settings.layoutOveride&&this.settings.layoutOveride.layout||a.layout||"reflowable",spread:this.settings.layoutOveride&&this.settings.layoutOveride.spread||a.spread||"auto",orientation:this.settings.layoutOveride&&this.settings.layoutOveride.orientation||a.orientation||"auto"}};RSVP.EventTarget.mixin(EPUBJS.Book.prototype);RSVP.on("error",function(a){console.error(a)});
EPUBJS.Chapter=function(a,b,c){this.href=a.href;this.absolute=a.url;this.id=a.id;this.spinePos=a.index;this.cfiBase=a.cfiBase;this.properties=a.properties;this.manifestProperties=a.manifestProperties;this.linear=a.linear;this.pages=1;this.store=b;this.credentials=c;this.epubcfi=new EPUBJS.EpubCFI;this.deferred=new RSVP.defer;this.loaded=this.deferred.promise;EPUBJS.Hooks.mixin(this);this.getHooks("beforeChapterRender");this.caches={}};
EPUBJS.Chapter.prototype.load=function(a,b){a=a||this.store;b=b||this.credentials;b=a?a.getXml(this.absolute):EPUBJS.core.request(this.absolute,!1,b);b.then(function(a){try{this.setDocument(a),this.deferred.resolve(this)}catch(d){this.deferred.reject({message:this.absolute+" -> "+d.message,stack:Error().stack})}}.bind(this));return b};
EPUBJS.Chapter.prototype.render=function(a){return this.load().then(function(a){var b=a.querySelector("head"),d=a.createElement("base");d.setAttribute("href",this.absolute);b.insertBefore(d,b.firstChild);this.contents=a;return new RSVP.Promise(function(b,c){this.triggerHooks("beforeChapterRender",function(){b(a)}.bind(this),this)}.bind(this))}.bind(this)).then(function(a){return(new XMLSerializer).serializeToString(a)}.bind(this))};
EPUBJS.Chapter.prototype.url=function(a){var b=new RSVP.defer;a=a||this.store;var c=this;a?this.tempUrl?(a=this.tempUrl,b.resolve(a)):a.getUrl(this.absolute).then(function(a){c.tempUrl=a;b.resolve(a)}):(a=this.absolute,b.resolve(a));return b.promise};EPUBJS.Chapter.prototype.setPages=function(a){this.pages=a};EPUBJS.Chapter.prototype.getPages=function(a){return this.pages};EPUBJS.Chapter.prototype.getID=function(){return this.ID};
EPUBJS.Chapter.prototype.unload=function(a){this.document=null;this.tempUrl&&a&&(a.revokeUrl(this.tempUrl),this.tempUrl=!1)};EPUBJS.Chapter.prototype.setDocument=function(a){this.document=a.implementation.createDocument(a.namespaceURI,null,null);this.contents=this.document.importNode(a.documentElement,!0);this.document.appendChild(this.contents);!this.document.evaluate&&document.evaluate&&(this.document.evaluate=document.evaluate)};
EPUBJS.Chapter.prototype.cfiFromRange=function(a){var b,c,d;if(this.document){if("undefined"!=typeof document.evaluate){c=EPUBJS.core.getElementXPath(a.startContainer);b=EPUBJS.core.getElementXPath(a.endContainer);c=this.document.evaluate(c,this.document,EPUBJS.core.nsResolver,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;a.collapsed||(d=this.document.evaluate(b,this.document,EPUBJS.core.nsResolver,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue);b=this.document.createRange();
if(c)try{b.setStart(c,a.startOffset),!a.collapsed&&d&&b.setEnd(d,a.endOffset)}catch(e){console.log("missed"),c=!1}!c&&(console.log("not found, try fuzzy match"),cleanStartTextContent=EPUBJS.core.cleanStringForXpath(a.startContainer.textContent),c="//text()[contains(.,"+cleanStartTextContent+")]",c=this.document.evaluate(c,this.document,EPUBJS.core.nsResolver,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue)&&(b.setStart(c,a.startOffset),a.collapsed||(d=EPUBJS.core.cleanStringForXpath(a.endContainer.textContent),
(d=this.document.evaluate("//text()[contains(.,"+d+")]",this.document,EPUBJS.core.nsResolver,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue)&&b.setEnd(d,a.endOffset)))}else b=a;return this.epubcfi.generateCfiFromRange(b,this.cfiBase)}};
EPUBJS.Chapter.prototype.find=function(a){var b=this,c=[],d=a.toLowerCase();this.textSprint(this.document,function(a){var e=a.textContent.toLowerCase(),g;b.document.createRange();var h;g=-1;for(var k;-1!=h;)h=e.indexOf(d,g+1),-1!=h&&(g=b.document.createRange(),g.setStart(a,h),g.setEnd(a,h+d.length),g=b.cfiFromRange(g),150>a.textContent.length?k=a.textContent:(k=a.textContent.substring(h-75,h+75),k="..."+k+"..."),c.push({cfi:g,excerpt:k})),g=h});return c};
EPUBJS.Chapter.prototype.textSprint=function(a,b){a=document.createTreeWalker(a,NodeFilter.SHOW_TEXT,{acceptNode:function(a){return a.data&&!/^\s*$/.test(a.data)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}},!1);for(var c;c=a.nextNode();)b(c)};EPUBJS.Chapter.prototype.replace=function(a,b,c,d){a=this.contents.querySelectorAll(a);a=Array.prototype.slice.call(a);var e=a.length;0===e?c(!1):a.forEach(function(a){var f=!1;b(a,function(a,b){!1===f&&(e--,d&&d(a,b,e),0>=e&&c&&c(!0),f=!0)})}.bind(this))};
EPUBJS.Chapter.prototype.replaceWithStored=function(a,b,c,d){var e,f={},g=this.store,h=this.caches[a],k=EPUBJS.core.uri(this.absolute).base;g&&(h||(h={}),e=EPUBJS.core.clone(h),this.replace(a,function(d,h){var m=d.getAttribute(b),l=EPUBJS.core.resolveUrl(k,m),m=function(c){var e;d.onload=function(){clearTimeout(e);h(c,l)};d.onerror=function(a){clearTimeout(e);h(c,l);console.error(a)};"svg image"==a&&d.setAttribute("externalResourcesRequired","true");"link[href]"==a&&"stylesheet"!==d.getAttribute("rel")?
h(c,l):e=setTimeout(function(){h(c,l)},5);c&&d.setAttribute(b,c)};l in e?(m(e[l]),f[l]=e[l],delete e[l]):c(g,l,m,d)},function(a){d&&d();EPUBJS.core.values(e).forEach(function(a){g.revokeUrl(a)});h=f},function(a,b,c){f[b]=a}))};EPUBJS=EPUBJS||{};EPUBJS.core={};EPUBJS.core.getEl=function(a){return document.getElementById(a)};EPUBJS.core.getEls=function(a){return document.getElementsByClassName(a)};
EPUBJS.core.request=function(a,b,c){var d=window.URL,e=d?"blob":"arraybuffer",f=new RSVP.defer,g=new XMLHttpRequest,h=XMLHttpRequest.prototype;"overrideMimeType"in h||Object.defineProperty(h,"overrideMimeType",{value:function(a){}});g.onreadystatechange=function(){var a;this.readyState==this.DONE&&(200!==this.status&&0!==this.status||!this.response?f.reject({message:this.response,stack:Error().stack}):(a="xml"==b?this.responseXML?this.responseXML:(new DOMParser).parseFromString(this.response,"application/xml"):
"xhtml"==b?this.responseXML?this.responseXML:(new DOMParser).parseFromString(this.response,"application/xhtml+xml"):"html"==b?this.responseXML?this.responseXML:(new DOMParser).parseFromString(this.response,"text/html"):"json"==b?JSON.parse(this.response):"blob"==b?d?this.response:new Blob([this.response]):this.response,f.resolve(a)))};g.open("GET",a,!0);c&&(g.withCredentials=!0);b||(a=EPUBJS.core.uri(a),b=a.extension,b={htm:"html"}[b]||b);"blob"==b&&(g.responseType=e);"json"==b&&g.setRequestHeader("Accept",
"application/json");"xml"==b&&(g.responseType="document",g.overrideMimeType("text/xml"));"xhtml"==b&&(g.responseType="document");"html"==b&&(g.responseType="document");"binary"==b&&(g.responseType="arraybuffer");g.send();return f.promise};EPUBJS.core.toArray=function(a){var b=[],c;for(c in a){var d;a.hasOwnProperty(c)&&(d=a[c],d.ident=c,b.push(d))}return b};
EPUBJS.core.uri=function(a){var b={protocol:"",host:"",path:"",origin:"",directory:"",base:"",filename:"",extension:"",fragment:"",href:a},c=a.indexOf("blob:"),d=a.indexOf("://"),e=a.indexOf("?"),f=a.indexOf("#");if(0===c)return b.protocol="blob",b.base=a.indexOf(0,f),b;-1!=f&&(b.fragment=a.slice(f+1),a=a.slice(0,f));-1!=e&&(b.search=a.slice(e+1),href=a=a.slice(0,e));-1!=d?(b.protocol=a.slice(0,d),c=a.slice(d+3),d=c.indexOf("/"),-1===d?(b.host=b.path,b.path=""):(b.host=c.slice(0,d),b.path=c.slice(d)),
b.origin=b.protocol+"://"+b.host,b.directory=EPUBJS.core.folder(b.path),b.base=b.origin+b.directory):(b.path=a,b.directory=EPUBJS.core.folder(a),b.base=b.directory);b.filename=a.replace(b.base,"");a=b.filename.lastIndexOf(".");-1!=a&&(b.extension=b.filename.slice(a+1));return b};EPUBJS.core.folder=function(a){var b=a.lastIndexOf("/");return a=a.slice(0,b+1)};
EPUBJS.core.dataURLToBlob=function(a){var b,c,d;if(-1==a.indexOf(";base64,"))return b=a.split(","),a=b[0].split(":")[1],b=b[1],new Blob([b],{type:a});b=a.split(";base64,");a=b[0].split(":")[1];b=window.atob(b[1]);c=b.length;d=new Uint8Array(c);for(var e=0;e<c;++e)d[e]=b.charCodeAt(e);return new Blob([d],{type:a})};
EPUBJS.core.addScript=function(a,b,c){var d,e;e=!1;d=document.createElement("script");d.type="text/javascript";d.async=!1;d.src=a;d.onload=d.onreadystatechange=function(){e||this.readyState&&"complete"!=this.readyState||(e=!0,b&&b())};c=c||document.body;c.appendChild(d)};EPUBJS.core.addScripts=function(a,b,c){var d=a.length,e=0,f=function(){e++;d==e?b&&b():EPUBJS.core.addScript(a[e],f,c)};EPUBJS.core.addScript(a[e],f,c)};
EPUBJS.core.addCss=function(a,b,c){var d,e;e=!1;d=document.createElement("link");d.type="text/css";d.rel="stylesheet";d.href=a;d.onload=d.onreadystatechange=function(){e||this.readyState&&"complete"!=this.readyState||(e=!0,b&&b())};c=c||document.body;c.appendChild(d)};
EPUBJS.core.prefixed=function(a){var b=["Webkit","Moz","O","ms"],c=a[0].toUpperCase()+a.slice(1),d=b.length;if("undefined"!=typeof document.documentElement.style[a])return a;for(var e=0;e<d;e++)if("undefined"!=typeof document.documentElement.style[b[e]+c])return b[e]+c;return a};EPUBJS.core.resolveUrl=function(a,b){var c=[],d=EPUBJS.core.uri(b),e=a.split("/");if(d.host)return b;e.pop();b.split("/").forEach(function(a){".."===a?e.pop():c.push(a)});return e.concat(c).join("/")};
EPUBJS.core.uuid=function(){var a=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=(a+16*Math.random())%16|0;a=Math.floor(a/16);return("x"==b?c:c&7|8).toString(16)})};EPUBJS.core.insert=function(a,b,c){c=EPUBJS.core.locationOf(a,b,c);b.splice(c,0,a);return c};
EPUBJS.core.locationOf=function(a,b,c,d,e){d=d||0;e=e||b.length;var f=parseInt(d+(e-d)/2),g;c||(c=function(a,b){if(a>b)return 1;if(a<b)return-1;if(b)return 0});if(0>=e-d)return f;g=c(b[f],a);return 1===e-d?0<g?f:f+1:0===g?f:-1===g?EPUBJS.core.locationOf(a,b,c,f,e):EPUBJS.core.locationOf(a,b,c,d,f)};
EPUBJS.core.indexOfSorted=function(a,b,c,d,e){d=d||0;e=e||b.length;var f=parseInt(d+(e-d)/2),g;c||(c=function(a,b){if(a>b)return 1;if(a<b)return-1;if(b)return 0});if(0>=e-d)return-1;g=c(b[f],a);return 1===e-d?0===g?f:-1:0===g?f:-1===g?EPUBJS.core.indexOfSorted(a,b,c,f,e):EPUBJS.core.indexOfSorted(a,b,c,d,f)};
EPUBJS.core.queue=function(a){var b=[],c=function(){var c;b.length&&(c=b.shift(),a[c.funcName].apply(c.context||a,c.args))};return{enqueue:function(a,c,f){b.push({funcName:a,args:c,context:f});return b},dequeue:c,flush:function(){for(;b.length;)c()},clear:function(){b=[]},length:function(){return b.length}}};EPUBJS.core.getElementXPath=function(a){return a&&a.id?'//*[@id="'+a.id+'"]':EPUBJS.core.getElementTreeXPath(a)};
EPUBJS.core.getElementTreeXPath=function(a){var b=[],c="http://www.w3.org/1999/xhtml"===a.ownerDocument.documentElement.getAttribute("xmlns"),d,e;a.nodeType===Node.TEXT_NODE&&(d=EPUBJS.core.indexOfTextNode(a)+1,b.push("text()["+d+"]"),a=a.parentNode);for(;a&&1==a.nodeType;a=a.parentNode){d=0;for(e=a.previousSibling;e;e=e.previousSibling)e.nodeType!=Node.DOCUMENT_TYPE_NODE&&e.nodeName==a.nodeName&&++d;e=a.nodeName.toLowerCase();e=c?"xhtml:"+e:e;d=d?"["+(d+1)+"]":"";b.splice(0,0,e+d)}return b.length?
"./"+b.join("/"):null};EPUBJS.core.nsResolver=function(a){return{xhtml:"http://www.w3.org/1999/xhtml",epub:"http://www.idpf.org/2007/ops"}[a]||null};EPUBJS.core.cleanStringForXpath=function(a){a=a.match(/[^'"]+|['"]/g);a=a.map(function(a){return"'"===a?'"\'"':'"'===a?"'\"'":"'"+a+"'"});return"concat('',"+a.join(",")+")"};EPUBJS.core.indexOfTextNode=function(a){for(var b=a.parentNode.childNodes,c,d=-1,e=0;e<b.length&&(c=b[e],c.nodeType===Node.TEXT_NODE&&d++,c!=a);e++);return d};
EPUBJS.core.defaults=function(a){for(var b=1,c=arguments.length;b<c;b++){var d=arguments[b],e;for(e in d)void 0===a[e]&&(a[e]=d[e])}return a};EPUBJS.core.extend=function(a){[].slice.call(arguments,1).forEach(function(b){b&&Object.getOwnPropertyNames(b).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))})});return a};EPUBJS.core.clone=function(a){return EPUBJS.core.isArray(a)?a.slice():EPUBJS.core.extend({},a)};EPUBJS.core.isElement=function(a){return!(!a||1!=a.nodeType)};
EPUBJS.core.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};EPUBJS.core.isString=function(a){return"string"===typeof a||a instanceof String};EPUBJS.core.isArray=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};EPUBJS.core.values=function(a){var b=-1,c,d,e;if(!a)return[];c=Object.keys(a);d=c.length;for(e=Array(d);++b<d;)e[b]=a[c[b]];return e};EPUBJS.EpubCFI=function(a){if(a)return this.parse(a)};
EPUBJS.EpubCFI.prototype.generateChapterComponent=function(a,b,c){b=parseInt(b);a="/"+(a+1)+"/"+2*(b+1);c&&(a+="["+c+"]");return a};EPUBJS.EpubCFI.prototype.generatePathComponent=function(a){var b=[];a.forEach(function(a){var c;c=""+2*(a.index+1);a.id&&(c+="["+a.id+"]");b.push(c)});return b.join("/")};EPUBJS.EpubCFI.prototype.generateCfiFromElement=function(a,b){a=this.pathTo(a);a=this.generatePathComponent(a);return a.length?"epubcfi("+b+"!"+a+"/1:0)":"epubcfi("+b+"!/4/)"};
EPUBJS.EpubCFI.prototype.pathTo=function(a){for(var b=[],c;a&&null!==a.parentNode&&9!=a.parentNode.nodeType;)c=a.parentNode.children,b.unshift({id:a.id,tagName:a.tagName,index:c?Array.prototype.indexOf.call(c,a):0}),a=a.parentNode;return b};EPUBJS.EpubCFI.prototype.getChapterComponent=function(a){return a.split("!")[0]};EPUBJS.EpubCFI.prototype.getPathComponent=function(a){a=a.split("!");return(a[1]?a[1].split(":"):"")[0]};
EPUBJS.EpubCFI.prototype.getCharecterOffsetComponent=EPUBJS.EpubCFI.prototype.getCharacterOffsetComponent=function(a){return a.split(":")[1]||""};
EPUBJS.EpubCFI.prototype.parse=function(a){var b={},c,d,e=function(a){var b,c;b=parseInt(a)/2-1;(a=a.match(/\[(.*)\]/))&&a[1]&&(c=a[1]);return{type:"element",index:b,id:c||!1}};if("string"!==typeof a)return{spinePos:-1};b.str=a;0===a.indexOf("epubcfi(")&&")"===a[a.length-1]&&(a=a.slice(8,a.length-1));c=this.getChapterComponent(a);d=this.getPathComponent(a)||"";a=this.getCharacterOffsetComponent(a);if(!c)return{spinePos:-1};c=c.split("/")[2]||"";if(!c)return{spinePos:-1};b.spinePos=parseInt(c)/2-1||
0;c=c.match(/\[(.*)\]/);b.spineId=c?c[1]:!1;-1!=d.indexOf(",")&&console.warn("CFI Ranges are not supported");c=d.split("/");d=c.pop();b.steps=[];c.forEach(function(a){a&&(a=e(a),b.steps.push(a))});c=parseInt(d);isNaN(c)||(0===c%2?b.steps.push(e(d)):b.steps.push({type:"text",index:(c-1)/2}));(d=a.match(/\[(.*)\]/))&&d[1]?(b.characterOffset=parseInt(a.split("[")[0]),b.textLocationAssertion=d[1]):b.characterOffset=parseInt(a);return b};
EPUBJS.EpubCFI.prototype.addMarker=function(a,b,c){b=b||document;c=c||this.createMarker(b);var d;"string"===typeof a&&(a=this.parse(a));d=a.steps[a.steps.length-1];if(-1===a.spinePos)return!1;b=this.findParent(a,b);if(!b)return!1;d&&"text"===d.type?(d=b.childNodes[d.index],a.characterOffset?(a=d.splitText(a.characterOffset),c.classList.add("EPUBJS-CFI-SPLIT"),b.insertBefore(c,a)):b.insertBefore(c,d)):b.insertBefore(c,b.firstChild);return c};
EPUBJS.EpubCFI.prototype.createMarker=function(a){a=(a||document).createElement("span");a.id="EPUBJS-CFI-MARKER:"+EPUBJS.core.uuid();a.classList.add("EPUBJS-CFI-MARKER");return a};
EPUBJS.EpubCFI.prototype.removeMarker=function(a,b){a.classList.contains("EPUBJS-CFI-SPLIT")?(nextSib=a.nextSibling,prevSib=a.previousSibling,nextSib&&prevSib&&3===nextSib.nodeType&&3===prevSib.nodeType&&(prevSib.textContent+=nextSib.textContent,a.parentNode.removeChild(nextSib)),a.parentNode.removeChild(a)):a.classList.contains("EPUBJS-CFI-MARKER")&&a.parentNode.removeChild(a)};
EPUBJS.EpubCFI.prototype.findParent=function(a,b){b=b||document;var c=b.getElementsByTagName("html")[0],d=Array.prototype.slice.call(c.children),e,f;"string"===typeof a&&(a=this.parse(a));f=a.steps.slice(0);if(!f.length)return b.getElementsByTagName("body")[0];for(;f&&0<f.length;){e=f.shift();"text"===e.type?(d=c.childNodes[e.index],c=d.parentNode||c):c=e.id?b.getElementById(e.id):d[e.index];if(!c||"undefined"===typeof c)return console.error("No Element For",e,a.str),!1;d=Array.prototype.slice.call(c.children)}return c};
EPUBJS.EpubCFI.prototype.compare=function(a,b){"string"===typeof a&&(a=new EPUBJS.EpubCFI(a));"string"===typeof b&&(b=new EPUBJS.EpubCFI(b));if(a.spinePos>b.spinePos)return 1;if(a.spinePos<b.spinePos)return-1;for(var c=0;c<a.steps.length;c++){if(!b.steps[c]||a.steps[c].index>b.steps[c].index)return 1;if(a.steps[c].index<b.steps[c].index)return-1}return a.steps.length<b.steps.length?-1:a.characterOffset>b.characterOffset?1:a.characterOffset<b.characterOffset?-1:0};
EPUBJS.EpubCFI.prototype.generateCfiFromHref=function(a,b){a=EPUBJS.core.uri(a);var c=a.fragment;a=b.spineIndexByURL[a.path];var d=new RSVP.defer,e=new EPUBJS.EpubCFI,f;"undefined"!==typeof a&&(f=b.spine[a],b=b.loadXml(f.url),b.then(function(a){a=a.getElementById(c);a=e.generateCfiFromElement(a,f.cfiBase);d.resolve(a)}));return d.promise};
EPUBJS.EpubCFI.prototype.generateCfiFromTextNode=function(a,b,c){var d=a.parentNode,e=this.pathTo(d),e=this.generatePathComponent(e);a=1+2*Array.prototype.indexOf.call(d.childNodes,a);return"epubcfi("+c+"!"+e+"/"+a+":"+(b||0)+")"};EPUBJS.EpubCFI.prototype.generateCfiFromRangeAnchor=function(a,b){return this.generateCfiFromTextNode(a.anchorNode,a.anchorOffset,b)};
EPUBJS.EpubCFI.prototype.generateCfiFromRange=function(a,b){var c,d,e,f,g,h;c=a.startContainer;if(3===c.nodeType)d=c.parentNode,e=1+2*EPUBJS.core.indexOfTextNode(c),c=this.pathTo(d);else{if(a.collapsed)return this.generateCfiFromElement(c,b);c=this.pathTo(c)}c=this.generatePathComponent(c);d=a.startOffset;if(a.collapsed)return"epubcfi("+b+"!"+c+"/"+e+":"+d+")";f=a.endContainer;3===f.nodeType?(g=f.parentNode,h=1+2*EPUBJS.core.indexOfTextNode(f),f=this.pathTo(g)):f=this.pathTo(f);f=this.generatePathComponent(f);
a=a.endOffset;f=f.replace(c,"");f.length&&(f+="/");return"epubcfi("+b+"!"+c+"/"+e+":"+d+","+f+h+":"+a+")"};EPUBJS.EpubCFI.prototype.generateXpathFromSteps=function(a){var b=[".","*"];a.forEach(function(a){var c=a.index+1;a.id?b.push("*[position()="+c+" and @id='"+a.id+"']"):"text"===a.type?b.push("text()["+c+"]"):b.push("*["+c+"]")});return b.join("/")};
EPUBJS.EpubCFI.prototype.generateQueryFromSteps=function(a){var b=["html"];a.forEach(function(a){var c=a.index+1;a.id?b.push("#"+a.id):"text"!==a.type&&b.push("*:nth-child("+c+")")});return b.join(">")};
EPUBJS.EpubCFI.prototype.generateRangeFromCfi=function(a,b){var c=b||document;b=c.createRange();var d,e,f;"string"===typeof a&&(a=this.parse(a));if(-1===a.spinePos)return!1;d=a.steps[a.steps.length-1];"undefined"!=typeof document.evaluate?(e=this.generateXpathFromSteps(a.steps),e=c.evaluate(e,c,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue):(f=this.generateQueryFromSteps(a.steps),(c=c.querySelector(f))&&"text"==d.type&&(e=c.childNodes[d.index]));if(!e)return null;e&&0<=a.characterOffset?
(c=e.length,a.characterOffset<c?b.setStart(e,a.characterOffset):(console.debug("offset greater than length:",a.characterOffset,c),b.setStart(e,c-1)),b.setEnd(e,c)):e&&b.selectNode(e);return b};EPUBJS.EpubCFI.prototype.isCfiString=function(a){return"string"===typeof a&&0===a.indexOf("epubcfi(")?!0:!1};
EPUBJS.Events=function(a,b){this.events={};this.el=b?b:document.createElement("div");a.createEvent=this.createEvent;a.tell=this.tell;a.listen=this.listen;a.deafen=this.deafen;a.listenUntil=this.listenUntil;return this};EPUBJS.Events.prototype.createEvent=function(a){var b=new CustomEvent(a);return this.events[a]=b};EPUBJS.Events.prototype.tell=function(a,b){this.events[a]?a=this.events[a]:(console.warn("No event:",a,"defined yet, creating."),a=this.createEvent(a));b&&(a.msg=b);this.el.dispatchEvent(a)};
EPUBJS.Events.prototype.listen=function(a,b,c){this.events[a]?c?this.el.addEventListener(a,b.bind(c),!1):this.el.addEventListener(a,b,!1):(console.warn("No event:",a,"defined yet, creating."),this.createEvent(a))};EPUBJS.Events.prototype.deafen=function(a,b){this.el.removeEventListener(a,b,!1)};EPUBJS.Events.prototype.listenUntil=function(a,b,c,d){function e(){this.deafen(a,c);this.deafen(b,e)}this.listen(a,c,d);this.listen(b,e,this)};EPUBJS.hooks={};
EPUBJS.Hooks=function(){function a(){}a.prototype.getHooks=function(){var a;this.hooks={};Array.prototype.slice.call(arguments).forEach(function(a){this.hooks[a]=[]},this);for(var c in this.hooks)a=EPUBJS.core.values(EPUBJS.hooks[c]),a.forEach(function(a){this.registerHook(c,a)},this)};a.prototype.registerHook=function(a,c,d){"undefined"!=typeof this.hooks[a]?"function"===typeof c?d?this.hooks[a].unshift(c):this.hooks[a].push(c):Array.isArray(c)&&c.forEach(function(b){d?this.hooks[a].unshift(b):this.hooks[a].push(b)},
this):(this.hooks[a]=[c],"function"===typeof c?this.hooks[a]=[c]:Array.isArray(c)&&(this.hooks[a]=[],c.forEach(function(b){this.hooks[a].push(b)},this)))};a.prototype.removeHook=function(a,c){var b;"undefined"!=typeof this.hooks[a]&&("function"===typeof c?(b=this.hooks[a].indexOf(c),-1<b&&this.hooks[a].splice(b,1)):Array.isArray(c)&&c.forEach(function(c){b=this.hooks[a].indexOf(c);-1<b&&this.hooks[a].splice(b,1)},this))};a.prototype.triggerHooks=function(a,c,d){function b(){f--;0>=f&&c&&c()}var f;
if("undefined"==typeof this.hooks[a])return!1;a=this.hooks[a];f=a.length;0===f&&c&&c();a.forEach(function(a){a(b,d)})};return{register:function(a){void 0===EPUBJS.hooks[a]&&(EPUBJS.hooks[a]={});if("object"!==typeof EPUBJS.hooks[a])throw"Already registered: "+a;return EPUBJS.hooks[a]},mixin:function(b){for(var c in a.prototype)b[c]=a.prototype[c]}}}();EPUBJS.Layout=EPUBJS.Layout||{};EPUBJS.Layout.Reflowable=function(){this.spreadWidth=this.documentElement=null};
EPUBJS.Layout.Reflowable.prototype.format=function(a,b,c,d){var e=EPUBJS.core.prefixed("columnAxis"),f=EPUBJS.core.prefixed("columnGap"),g=EPUBJS.core.prefixed("columnWidth"),h=EPUBJS.core.prefixed("columnFill");b=Math.floor(b);var k=Math.floor(b/8);d=0<=d?d:0===k%2?k:k-1;this.documentElement=a;this.spreadWidth=b+d;a.style.overflow="hidden";a.style.width=b+"px";a.style.height=c+"px";a.style[e]="horizontal";a.style[h]="auto";a.style[g]=b+"px";a.style[f]=d+"px";this.colWidth=b;this.gap=d;return{pageWidth:this.spreadWidth,
pageHeight:c}};EPUBJS.Layout.Reflowable.prototype.calculatePages=function(){var a;this.documentElement.style.width="auto";a=Math.ceil(this.documentElement.scrollWidth/this.spreadWidth);return{displayedPages:a,pageCount:a}};EPUBJS.Layout.ReflowableSpreads=function(){this.spreadWidth=this.documentElement=null};
EPUBJS.Layout.ReflowableSpreads.prototype.format=function(a,b,c,d){var e=EPUBJS.core.prefixed("columnAxis"),f=EPUBJS.core.prefixed("columnGap"),g=EPUBJS.core.prefixed("columnWidth"),h=EPUBJS.core.prefixed("columnFill");b=Math.floor(b);b=0===b%2?b:b-1;var k=Math.floor(b/8);d=0<=d?d:0===k%2?k:k-1;k=Math.floor((b-d)/2);this.documentElement=a;this.spreadWidth=2*(k+d);a.style.overflow="hidden";a.style.width=b+"px";a.style.height=c+"px";a.style[e]="horizontal";a.style[h]="auto";a.style[f]=d+"px";a.style[g]=
k+"px";this.colWidth=k;this.gap=d;return{pageWidth:this.spreadWidth,pageHeight:c}};EPUBJS.Layout.ReflowableSpreads.prototype.calculatePages=function(){var a=Math.ceil(this.documentElement.scrollWidth/this.spreadWidth);this.documentElement.style.width=a*this.spreadWidth-this.gap+"px";return{displayedPages:a,pageCount:2*a}};EPUBJS.Layout.Fixed=function(){this.documentElement=null};
EPUBJS.Layout.Fixed.prototype.format=function(a,b,c,d){b=EPUBJS.core.prefixed("columnWidth");c=a.querySelector("[name=viewport]");var e,f;this.documentElement=a;c&&c.hasAttribute("content")&&(c=c.getAttribute("content"),c=c.split(","),c[0]&&(e=c[0].replace("width=","")),c[1]&&(f=c[1].replace("height=","")));a.style.width=e+"px"||"auto";a.style.height=f+"px"||"auto";a.style[b]="auto";a.style.overflow="auto";this.colWidth=e;this.gap=0;return{pageWidth:e,pageHeight:f}};
EPUBJS.Layout.Fixed.prototype.calculatePages=function(){return{displayedPages:1,pageCount:1}};EPUBJS.Locations=function(a,b,c){this.spine=a;this.store=b;this.credentials=c;this.epubcfi=new EPUBJS.EpubCFI;this._locations=[];this.total=0;this.break=150;this._current=0};
EPUBJS.Locations.prototype.generate=function(a){var b=new RSVP.defer,c=-1,d=this.spine.length,e=function(a){var b=c+1,f=a||new RSVP.defer;b>=d?f.resolve():(c=b,a=new EPUBJS.Chapter(this.spine[c],this.store,this.credentials),this.process(a).then(function(){setTimeout(function(){e(f)},1)}));return f.promise}.bind(this);"number"===typeof a&&(this.break=a);e().then(function(){this.total=this._locations.length-1;this._currentCfi&&(this.currentLocation=this._currentCfi);b.resolve(this._locations)}.bind(this));
return b.promise};
EPUBJS.Locations.prototype.process=function(a){return a.load().then(function(b){var c,d=b.documentElement.querySelector("body"),e=0,f,g;this.sprint(d,function(d){var h=d.length,m=0;0===e&&(c=b.createRange(),c.setStart(d,0));this.break-e>h&&(e+=h,m=h);for(;m<h;)e=this.break,m+=this.break,m>=h?e=h-(m-this.break):(c.setEnd(d,m),g=a.cfiFromRange(c),this._locations.push(g),e=0,m+=1,c=b.createRange(),c.setStart(d,m));f=d}.bind(this));c&&(c.setEnd(f,f.length),g=a.cfiFromRange(c),this._locations.push(g),e=
0)}.bind(this))};EPUBJS.Locations.prototype.sprint=function(a,b){for(var c=document.createTreeWalker(a,NodeFilter.SHOW_TEXT,null,!1);a=c.nextNode();)b(a)};EPUBJS.Locations.prototype.locationFromCfi=function(a){return 0===this._locations.length?-1:EPUBJS.core.locationOf(a,this._locations,this.epubcfi.compare)};EPUBJS.Locations.prototype.percentageFromCfi=function(a){a=this.locationFromCfi(a);return this.percentageFromLocation(a)};
EPUBJS.Locations.prototype.percentageFromLocation=function(a){return a&&this.total?a/this.total:0};EPUBJS.Locations.prototype.cfiFromLocation=function(a){var b=-1;"number"!=typeof a&&(a=parseInt(a));0<=a&&a<this._locations.length&&(b=this._locations[a]);return b};EPUBJS.Locations.prototype.cfiFromPercentage=function(a){return this.cfiFromLocation(Math.ceil(this.total*(1<a?a/100:a)))};EPUBJS.Locations.prototype.load=function(a){this._locations=JSON.parse(a);this.total=this._locations.length-1;return this._locations};
EPUBJS.Locations.prototype.save=function(a){return JSON.stringify(this._locations)};EPUBJS.Locations.prototype.getCurrent=function(a){return this._current};EPUBJS.Locations.prototype.setCurrent=function(a){if("string"==typeof a)this._currentCfi=a;else if("number"==typeof a)this._current=a;else return;0!==this._locations.length&&("string"==typeof a&&(this._current=a=this.locationFromCfi(a)),this.trigger("changed",{percentage:this.percentageFromLocation(a)}))};
Object.defineProperty(EPUBJS.Locations.prototype,"currentLocation",{get:function(){return this._current},set:function(a){this.setCurrent(a)}});RSVP.EventTarget.mixin(EPUBJS.Locations.prototype);EPUBJS.Pagination=function(a){this.pages=[];this.locations=[];this.epubcfi=new EPUBJS.EpubCFI;a&&a.length&&this.process(a)};
EPUBJS.Pagination.prototype.process=function(a){a.forEach(function(a){this.pages.push(a.page);this.locations.push(a.cfi)},this);this.pageList=a;this.firstPage=parseInt(this.pages[0]);this.lastPage=parseInt(this.pages[this.pages.length-1]);this.totalPages=this.lastPage-this.firstPage};
EPUBJS.Pagination.prototype.pageFromCfi=function(a){if(0===this.locations.length)return-1;var b=EPUBJS.core.indexOfSorted(a,this.locations,this.epubcfi.compare);-1!=b?a=this.pages[b]:(b=EPUBJS.core.locationOf(a,this.locations,this.epubcfi.compare),a=0<=b-1?this.pages[b-1]:this.pages[0],void 0===a&&(a=-1));return a};EPUBJS.Pagination.prototype.cfiFromPage=function(a){var b=-1;"number"!=typeof a&&(a=parseInt(a));a=this.pages.indexOf(a);-1!=a&&(b=this.locations[a]);return b};
EPUBJS.Pagination.prototype.pageFromPercentage=function(a){return Math.round(this.totalPages*a)};EPUBJS.Pagination.prototype.percentageFromPage=function(a){return Math.round((a-this.firstPage)/this.totalPages*1E3)/1E3};EPUBJS.Pagination.prototype.percentageFromCfi=function(a){a=this.pageFromCfi(a);return this.percentageFromPage(a)};EPUBJS.Parser=function(a){this.baseUrl=a||""};
EPUBJS.Parser.prototype.container=function(a){var b,c;if(a){if(b=a.querySelector("rootfile"))return b=b.getAttribute("full-path"),c=EPUBJS.core.uri(b).directory,{packagePath:b,basePath:c,encoding:a.xmlEncoding};console.error("No RootFile Found")}else console.error("Container File Not Found")};EPUBJS.Parser.prototype.identifier=function(a){if(a){if(a=a.querySelector("metadata"))return this.getElementText(a,"identifier");console.error("No Metadata Found")}else console.error("Package File Not Found")};
EPUBJS.Parser.prototype.packageContents=function(a,b){var c,d,e,f,g,h,k;b&&(this.baseUrl=b);if(a)if(c=a.querySelector("metadata"))if(d=a.querySelector("manifest")){if(b=a.querySelector("spine"))return e=this.manifest(d),f=this.findNavPath(d),d=this.findTocPath(d,b),a=this.findCoverPath(a),g=Array.prototype.indexOf.call(b.parentNode.childNodes,b),h=this.spine(b,e),k={},h.forEach(function(a){k[a.href]=a.index}),c=this.metadata(c),c.direction=b.getAttribute("page-progression-direction"),{metadata:c,
spine:h,manifest:e,navPath:f,tocPath:d,coverPath:a,spineNodeIndex:g,spineIndexByURL:k};console.error("No Spine Found")}else console.error("No Manifest Found");else console.error("No Metadata Found");else console.error("Package File Not Found")};EPUBJS.Parser.prototype.findNavPath=function(a){return(a=a.querySelector("item[properties$='nav'], item[properties^='nav '], item[properties*=' nav ']"))?a.getAttribute("href"):!1};
EPUBJS.Parser.prototype.findTocPath=function(a,b){var c=a.querySelector("item[media-type='application/x-dtbncx+xml']");c||(b=b.getAttribute("toc"))&&(c=a.querySelector("item[id='"+b+"']"));return c?c.getAttribute("href"):!1};
EPUBJS.Parser.prototype.metadata=function(a){var b={};b.bookTitle=this.getElementText(a,"title");b.creator=this.getElementText(a,"creator");b.description=this.getElementText(a,"description");b.pubdate=this.getElementText(a,"date");b.publisher=this.getElementText(a,"publisher");b.identifier=this.getElementText(a,"identifier");b.language=this.getElementText(a,"language");b.rights=this.getElementText(a,"rights");b.modified_date=this.querySelectorText(a,"meta[property='dcterms:modified']");b.layout=this.querySelectorText(a,
"meta[property='rendition:layout']");b.orientation=this.querySelectorText(a,"meta[property='rendition:orientation']");b.spread=this.querySelectorText(a,"meta[property='rendition:spread']");return b};
EPUBJS.Parser.prototype.findCoverPath=function(a){if("2.0"===a.querySelector("package").getAttribute("version")){var b=a.querySelector('meta[name="cover"]');return b?(b=b.getAttribute("content"),(a=a.querySelector("item[id='"+b+"']"))?a.getAttribute("href"):!1):!1}return(a=a.querySelector("item[properties='cover-image']"))?a.getAttribute("href"):!1};
EPUBJS.Parser.prototype.getElementText=function(a,b){a=a.getElementsByTagNameNS("http://purl.org/dc/elements/1.1/",b);if(!a||0===a.length)return"";a=a[0];return a.childNodes.length?a.childNodes[0].nodeValue:""};EPUBJS.Parser.prototype.querySelectorText=function(a,b){return(a=a.querySelector(b))&&a.childNodes.length?a.childNodes[0].nodeValue:""};
EPUBJS.Parser.prototype.manifest=function(a){var b=this.baseUrl,c={};a=a.querySelectorAll("item");Array.prototype.slice.call(a).forEach(function(a){var d=a.getAttribute("id"),f=a.getAttribute("href")||"",g=a.getAttribute("media-type")||"";a=a.getAttribute("properties")||"";c[d]={href:f,url:b+f,type:g,properties:a}});return c};
EPUBJS.Parser.prototype.spine=function(a,b){var c=[],d=a.getElementsByTagName("itemref"),d=Array.prototype.slice.call(d),e=Array.prototype.indexOf.call(a.parentNode.childNodes,a),f=new EPUBJS.EpubCFI;d.forEach(function(a,d){var g=a.getAttribute("idref"),h=f.generateChapterComponent(e,d,g),p=a.getAttribute("properties")||"",p=p.length?p.split(" "):[],u=b[g].properties,u=u.length?u.split(" "):[];a={id:g,linear:a.getAttribute("linear")||"",properties:p,manifestProperties:u,href:b[g].href,url:b[g].url,
index:d,cfiBase:h,cfi:"epubcfi("+h+")"};c.push(a)});return c};EPUBJS.Parser.prototype.querySelectorByType=function(a,b,c){var d=a.querySelector(b+'[*|type="'+c+'"]');if(null===d||0===d.length)for(d=a.querySelectorAll(b),a=0;a<d.length;a++){if(d[a].getAttributeNS("http://www.idpf.org/2007/ops","type")===c)return d[a]}else return d};
EPUBJS.Parser.prototype.nav=function(a,b,c){a=(a=this.querySelectorByType(a,"nav","toc"))?a.querySelectorAll("ol li"):[];var d=a.length,e,f={},g=[],h,k;if(!a||0===d)return g;for(e=0;e<d;++e)h=this.navItem(a[e],b,c),f[h.id]=h,h.parent?(k=f[h.parent],k.subitems.push(h)):g.push(h);return g};
EPUBJS.Parser.prototype.navItem=function(a,b,c){var d=a.getAttribute("id")||!1,e=a.querySelector("a, span"),f=e.getAttribute("href")||"",e=e.textContent||"",g=f.split("#")[0];b=b[g];var h=c[b],g=a.parentNode,k,h=h?h.cfi:"";g&&"navPoint"===g.nodeName&&(k=g.getAttribute("id"));d||(b?(h=c[b],d=h.id,h=h.cfi):(d="epubjs-autogen-toc-id-"+EPUBJS.core.uuid(),a.setAttribute("id",d)));return{id:d,href:f,label:e,spinePos:b,subitems:[],parent:k,cfi:h}};
EPUBJS.Parser.prototype.toc=function(a,b,c){a=a.querySelectorAll("navMap navPoint");var d=a.length,e,f={},g=[],h,k;if(!a||0===d)return g;for(e=0;e<d;++e)h=this.tocItem(a[e],b,c),f[h.id]=h,h.parent?(k=f[h.parent],k.subitems.push(h)):g.push(h);return g};
EPUBJS.Parser.prototype.tocItem=function(a,b,c){var d=a.getAttribute("id")||!1,e=a.querySelector("content").getAttribute("src"),f=a.querySelector("navLabel"),f=f.textContent?f.textContent:"",g=e.split("#")[0];b=b[g];var h=c[b],g=a.parentNode,k,h=h?h.cfi:"";g&&"navPoint"===g.nodeName&&(k=g.getAttribute("id"));d||(b?(h=c[b],d=h.id,h=h.cfi):(d="epubjs-autogen-toc-id-"+EPUBJS.core.uuid(),a.setAttribute("id",d)));return{id:d,href:e,label:f,spinePos:b,subitems:[],parent:k,cfi:h}};
EPUBJS.Parser.prototype.pageList=function(a,b,c){a=(a=this.querySelectorByType(a,"nav","page-list"))?a.querySelectorAll("ol li"):[];var d=a.length,e,f=[],g;if(!a||0===d)return f;for(e=0;e<d;++e)g=this.pageListItem(a[e],b,c),f.push(g);return f};
EPUBJS.Parser.prototype.pageListItem=function(a,b,c){a.getAttribute("id");b=a.querySelector("a");a=b.getAttribute("href")||"";b=parseInt(b.textContent||"");var d;return-1!=a.indexOf("epubcfi")?(d=a.split("#"),c=d[0],d=1<d.length?d[1]:!1,{cfi:d,href:a,packageUrl:c,page:b}):{href:a,page:b}};EPUBJS.Render.Iframe=function(){this.bodyEl=this.docEl=this.window=this.document=this.iframe=null;this.pageWidth=this.leftPos=0};
EPUBJS.Render.Iframe.prototype.create=function(){this.iframe=document.createElement("iframe");this.iframe.id="epubjs-iframe:"+EPUBJS.core.uuid();this.iframe.scrolling="no";this.iframe.seamless="seamless";this.iframe.style.border="none";this.iframe.addEventListener("load",this.loaded.bind(this),!1);this.isMobile=navigator.userAgent.match(/(iPad|iPhone|iPod|Mobile|Android)/g);this.transform=EPUBJS.core.prefixed("transform");return this.iframe};
EPUBJS.Render.Iframe.prototype.load=function(a,b){var c=this,d=new RSVP.defer;this.window&&this.unload();this.iframe.onload=function(a){c.document=c.iframe.contentDocument;c.docEl=c.document.documentElement;c.headEl=c.document.head;c.bodyEl=c.document.body||c.document.querySelector("body");c.window=c.iframe.contentWindow;c.window.addEventListener("resize",c.resized.bind(c),!1);c.leftPos=0;c.setLeft(0);c.bodyEl&&(c.bodyEl.style.margin="0");"rtl"==c.direction&&"rtl"!=c.docEl.dir&&(c.docEl.dir="rtl",
c.docEl.style.position="absolute",c.docEl.style.right="0");d.resolve(c.docEl)};this.iframe.onerror=function(a){d.reject({message:"Error Loading Contents: "+a,stack:Error().stack})};this.document=this.iframe.contentDocument;if(!this.document)return d.reject(Error("No Document Available")),d.promise;this.iframe.contentDocument.open();this.iframe.contentDocument.write(a);this.iframe.contentDocument.close();return d.promise};
EPUBJS.Render.Iframe.prototype.loaded=function(a){a=this.iframe.contentWindow.location.href;this.document=this.iframe.contentDocument;this.docEl=this.document.documentElement;this.headEl=this.document.head;this.bodyEl=this.document.body||this.document.querySelector("body");this.window=this.iframe.contentWindow;"about:blank"!=a&&(a=this.iframe.contentDocument.querySelector("base"),a=a.getAttribute("href"),this.trigger("render:loaded",a))};
EPUBJS.Render.Iframe.prototype.resize=function(a,b){this.iframe&&(this.iframe.height=b,isNaN(a)||0===a%2||(a+=1),this.iframe.width=a,this.width=this.iframe.getBoundingClientRect().width||a,this.height=this.iframe.getBoundingClientRect().height||b)};EPUBJS.Render.Iframe.prototype.resized=function(a){this.width=this.iframe.getBoundingClientRect().width;this.height=this.iframe.getBoundingClientRect().height};EPUBJS.Render.Iframe.prototype.totalWidth=function(){return this.docEl.scrollWidth};
EPUBJS.Render.Iframe.prototype.totalHeight=function(){return this.docEl.scrollHeight};EPUBJS.Render.Iframe.prototype.setPageDimensions=function(a,b){this.pageWidth=a;this.pageHeight=b};EPUBJS.Render.Iframe.prototype.setDirection=function(a){this.direction=a;this.docEl&&"rtl"==this.docEl.dir&&(this.docEl.dir="rtl",this.docEl.style.position="static",this.docEl.style.right="auto")};
EPUBJS.Render.Iframe.prototype.setLeft=function(a){this.isMobile?this.docEl.style[this.transform]="translate("+-a+"px, 0)":this.document.defaultView.scrollTo(a,0)};EPUBJS.Render.Iframe.prototype.setStyle=function(a,b,c){c&&(a=EPUBJS.core.prefixed(a));this.bodyEl&&(this.bodyEl.style[a]=b)};EPUBJS.Render.Iframe.prototype.removeStyle=function(a){this.bodyEl&&(this.bodyEl.style[a]="")};
EPUBJS.Render.Iframe.prototype.addHeadTag=function(a,b,c){c=c||this.document;a=c.createElement(a);c=c.head;for(var d in b)a.setAttribute(d,b[d]);c&&c.insertBefore(a,c.firstChild)};EPUBJS.Render.Iframe.prototype.page=function(a){this.leftPos=this.pageWidth*(a-1);"rtl"===this.direction&&(this.leftPos*=-1);this.setLeft(this.leftPos)};EPUBJS.Render.Iframe.prototype.getPageNumberByElement=function(a){if(a)return a=this.leftPos+a.getBoundingClientRect().left,Math.floor(a/this.pageWidth)+1};
EPUBJS.Render.Iframe.prototype.getPageNumberByRect=function(a){return Math.floor((this.leftPos+a.left)/this.pageWidth)+1};EPUBJS.Render.Iframe.prototype.getBaseElement=function(){return this.bodyEl};EPUBJS.Render.Iframe.prototype.getDocumentElement=function(){return this.docEl};EPUBJS.Render.Iframe.prototype.isElementVisible=function(a){var b;return a&&"function"===typeof a.getBoundingClientRect&&(a=a.getBoundingClientRect(),b=a.left,0!==a.width&&0!==a.height&&0<=b&&b<this.pageWidth)?!0:!1};
EPUBJS.Render.Iframe.prototype.scroll=function(a){this.iframe.scrolling=a?"yes":"no"};EPUBJS.Render.Iframe.prototype.unload=function(){this.window.removeEventListener("resize",this.resized);this.window.location.reload()};RSVP.EventTarget.mixin(EPUBJS.Render.Iframe.prototype);
EPUBJS.Renderer=function(a,b){this.listenedEvents="keydown keyup keypressed mouseup mousedown click".split(" ");this.upEvent="mouseup";this.downEvent="mousedown";"ontouchstart"in document.documentElement&&(this.listenedEvents.push("touchstart","touchend"),this.upEvent="touchend",this.downEvent="touchstart");a&&"undefined"!=typeof EPUBJS.Render[a]?this.render=new EPUBJS.Render[a]:console.error("Not a Valid Rendering Method");this.render.on("render:loaded",this.loaded.bind(this));this.caches={};this.epubcfi=
new EPUBJS.EpubCFI;this.spreads=!0;this.isForcedSingle=!1;this.resized=this.onResized.bind(this);this.layoutSettings={};this.hidden=b||!1;EPUBJS.Hooks.mixin(this);this.getHooks("beforeChapterDisplay");this._q=EPUBJS.core.queue(this);this._moving=!1};EPUBJS.Renderer.prototype.Events="renderer:keydown renderer:keyup renderer:keypressed renderer:mouseup renderer:mousedown renderer:click renderer:touchstart renderer:touchend renderer:selected renderer:chapterUnload renderer:chapterUnloaded renderer:chapterDisplayed renderer:locationChanged renderer:visibleLocationChanged renderer:visibleRangeChanged renderer:resized renderer:spreads".split(" ");
EPUBJS.Renderer.prototype.initialize=function(a,b,c){this.container=a;this.element=this.render.create();this.initWidth=b;this.initHeight=c;this.width=b||this.container.clientWidth;this.height=c||this.container.clientHeight;this.container.appendChild(this.element);b&&c?this.render.resize(this.width,this.height):this.render.resize("100%","100%");document.addEventListener("orientationchange",this.onResized)};
EPUBJS.Renderer.prototype.displayChapter=function(a,b){if(this._moving){console.warning("Rendering In Progress");var c=new RSVP.defer;c.reject({message:"Rendering In Progress",stack:Error().stack});return c.promise}this._moving=!0;return a.render().then(function(c){this.currentChapter&&(this.trigger("renderer:chapterUnload"),this.currentChapter.unload(),this.render.window&&this.render.window.removeEventListener("resize",this.resized),this.removeEventListeners(),this.removeSelectionListeners(),this.trigger("renderer:chapterUnloaded"),
this.pageMap=this.doc=this.contents=null);this.currentChapter=a;this.chapterPos=1;this.currentChapterCfiBase=a.cfiBase;this.layoutSettings=this.reconcileLayoutSettings(b,a.properties);return this.load(c,a.href)}.bind(this),function(){this._moving=!1}.bind(this))};
EPUBJS.Renderer.prototype.load=function(a,b){var c=new RSVP.defer;this.layoutMethod=this.determineLayout(this.layoutSettings);this.layout=new EPUBJS.Layout[this.layoutMethod];this.visible(!1);this.render.load(a,b).then(function(a){this.afterLoad(a);this.beforeDisplay(function(){this.afterDisplay();this.visible(!0);c.resolve(this)}.bind(this))}.bind(this));return c.promise};
EPUBJS.Renderer.prototype.afterLoad=function(a){this.currentChapter.setDocument(this.render.document);this.contents=a;this.doc=this.render.document;this.formated=this.layout.format(a,this.render.width,this.render.height,this.gap);this.render.setPageDimensions(this.formated.pageWidth,this.formated.pageHeight);this.initWidth||this.initHeight||this.render.window.addEventListener("resize",this.resized,!1);this.addEventListeners();this.addSelectionListeners()};
EPUBJS.Renderer.prototype.afterDisplay=function(a){a=this.layout.calculatePages();var b=this.currentChapter,c=this._q.length();this._moving=!1;this.updatePages(a);this.visibleRangeCfi=this.getVisibleRangeCfi();this.currentLocationCfi=this.visibleRangeCfi.start;0===c&&(this.trigger("renderer:locationChanged",this.currentLocationCfi),this.trigger("renderer:visibleRangeChanged",this.visibleRangeCfi));b.cfi=this.currentLocationCfi;this.trigger("renderer:chapterDisplayed",b)};
EPUBJS.Renderer.prototype.loaded=function(a){this.trigger("render:loaded",a)};EPUBJS.Renderer.prototype.reconcileLayoutSettings=function(a,b){var c={},d;for(d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);b.forEach(function(a){var b=a.replace("rendition:",""),d=b.indexOf("-");-1!=d&&(a=b.slice(0,d),b=b.slice(d+1),c[a]=b)});return c};
EPUBJS.Renderer.prototype.determineLayout=function(a){var b=this.determineSpreads(this.minSpreadWidth),c=b?"ReflowableSpreads":"Reflowable",d=!1;"pre-paginated"===a.layout&&(c="Fixed",d=!0,b=!1);"reflowable"===a.layout&&"none"===a.spread&&(c="Reflowable",b=d=!1);"reflowable"===a.layout&&"both"===a.spread&&(c="ReflowableSpreads",d=!1,b=!0);this.spreads=b;this.render.scroll(d);this.trigger("renderer:spreads",b);return c};
EPUBJS.Renderer.prototype.beforeDisplay=function(a,b){this.triggerHooks("beforeChapterDisplay",a,this)};EPUBJS.Renderer.prototype.updatePages=function(a){this.pageMap=this.mapPage();this.displayedPages=this.spreads?Math.ceil(this.pageMap.length/2):this.pageMap.length;this.currentChapter.pages=this.pageMap.length;this._q.flush()};
EPUBJS.Renderer.prototype.reformat=function(){var a;this.contents&&(a=this.determineSpreads(this.minSpreadWidth),a!=this.spreads&&(this.spreads=a,this.layoutMethod=this.determineLayout(this.layoutSettings),this.layout=new EPUBJS.Layout[this.layoutMethod]),this.chapterPos=1,this.render.page(this.chapterPos),this.formated=this.layout.format(this.render.docEl,this.render.width,this.render.height,this.gap),this.render.setPageDimensions(this.formated.pageWidth,this.formated.pageHeight),a=this.layout.calculatePages(),
this.updatePages(a),this.currentLocationCfi&&this.gotoCfi(this.currentLocationCfi))};EPUBJS.Renderer.prototype.visible=function(a){if("undefined"===typeof a)return this.element.style.visibility;!0!==a||this.hidden?!1===a&&(this.element.style.visibility="hidden"):this.element.style.visibility="visible"};
EPUBJS.Renderer.prototype.remove=function(){this.render.window&&(this.render.unload(),this.render.window.removeEventListener("resize",this.resized),this.removeEventListeners(),this.removeSelectionListeners());this.container.removeChild(this.element)};EPUBJS.Renderer.prototype.applyStyles=function(a){for(var b in a)this.render.setStyle(b,a[b])};EPUBJS.Renderer.prototype.setStyle=function(a,b,c){this.render.setStyle(a,b,c)};EPUBJS.Renderer.prototype.removeStyle=function(a){this.render.removeStyle(a)};
EPUBJS.Renderer.prototype.applyHeadTags=function(a){for(var b in a)this.render.addHeadTag(b,a[b])};
EPUBJS.Renderer.prototype.page=function(a){return this.pageMap?1<=a&&a<=this.displayedPages?(this.chapterPos=a,this.render.page(a),this.visibleRangeCfi=this.getVisibleRangeCfi(),this.currentLocationCfi=this.visibleRangeCfi.start,this.trigger("renderer:locationChanged",this.currentLocationCfi),this.trigger("renderer:visibleRangeChanged",this.visibleRangeCfi),!0):!1:(console.warn("pageMap not set, queuing"),this._q.enqueue("page",arguments),!0)};
EPUBJS.Renderer.prototype.nextPage=function(){return this.page(this.chapterPos+1)};EPUBJS.Renderer.prototype.prevPage=function(){return this.page(this.chapterPos-1)};EPUBJS.Renderer.prototype.pageByElement=function(a){a&&(a=this.render.getPageNumberByElement(a),this.page(a))};EPUBJS.Renderer.prototype.lastPage=function(){if(this._moving)return this._q.enqueue("lastPage",arguments);this.page(this.displayedPages)};
EPUBJS.Renderer.prototype.firstPage=function(){if(this._moving)return this._q.enqueue("firstPage",arguments);this.page(1)};EPUBJS.Renderer.prototype.section=function(a){(a=this.doc.getElementById(a))&&this.pageByElement(a)};EPUBJS.Renderer.prototype.firstElementisTextNode=function(a){a=a.childNodes;return a.length&&a[0]&&3===a[0].nodeType&&a[0].textContent.trim().length?!0:!1};
EPUBJS.Renderer.prototype.isGoodNode=function(a){return-1!=="audio canvas embed iframe img math object svg video".split(" ").indexOf(a.tagName.toLowerCase())?!0:this.firstElementisTextNode(a)};
EPUBJS.Renderer.prototype.walk=function(a,b,c){for(var d,e,f=a,g,h=[f],k=0;!d&&h.length;){a=h.shift();this.containsPoint(a,b,c)&&this.isGoodNode(a)&&(d=a);if(!d&&a&&0<a.childElementCount){if((a=a.children)&&a.length)e=a.length?a.length:0;else break;for(--e;0<=e;e--)a[e]!=g&&h.unshift(a[e])}!d&&0===h.length&&f&&null!==f.parentNode&&(h.push(f.parentNode),g=f,f=f.parentNode);k++;if(1E4<k){console.error("ENDLESS LOOP");break}}return d};
EPUBJS.Renderer.prototype.containsPoint=function(a,b,c){return a&&"function"===typeof a.getBoundingClientRect&&(a=a.getBoundingClientRect(),0!==a.width&&0!==a.height&&a.left>=b&&b<=a.left+a.width)?!0:!1};
EPUBJS.Renderer.prototype.textSprint=function(a,b){var c=function(a){return/^\s*$/.test(a.data)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT},d,e;try{for(d=document.createTreeWalker(a,NodeFilter.SHOW_TEXT,{acceptNode:c},!1);e=d.nextNode();)b(e)}catch(f){for(d=document.createTreeWalker(a,NodeFilter.SHOW_TEXT,c,!1);e=d.nextNode();)b(e)}};EPUBJS.Renderer.prototype.sprint=function(a,b){a=document.createTreeWalker(a,NodeFilter.SHOW_ELEMENT,null,!1);for(var c;c=a.nextNode();)b(c)};
EPUBJS.Renderer.prototype.mapPage=function(){var a=this,b=[],c=this.render.getBaseElement(),d=1,e=this.layout.colWidth+this.layout.gap,f=this.formated.pageWidth*(this.chapterPos-1),g=e*d-f,h=0,k,m,p,u,l,n,y=function(c){var l;a.splitTextNodeIntoWordsRanges(c).forEach(function(c){var n=c.getBoundingClientRect();!n||0===n.width&&0===n.height||(n.left+n.width<g?b[d-1]||(c.collapse(!0),p=a.currentChapter.cfiFromRange(c),l=b.push({start:p,end:null})):(!k&&u&&(m=a.splitTextNodeIntoWordsRanges(u),k=m[m.length-
1]),k&&(k.collapse(!1),p=a.currentChapter.cfiFromRange(k),b[b.length-1].end=p),c.collapse(!0),p=a.currentChapter.cfiFromRange(c),l=b.push({start:p,end:null}),d+=1,h=g=e*d-f),k=c)});return l};l=this.render.getDocumentElement();n=l.dir;"rtl"==n&&(l.dir="ltr",l.style.position="static");this.textSprint(c,function(a){var b,c;a.nodeType==Node.TEXT_NODE&&(b=document.createRange(),b.selectNodeContents(a),!(b=b.getBoundingClientRect())||0===b.width&&0===b.height||(b.left>h&&(c=y(a)),b.right>h&&(c=y(a)),u=
a,c&&(k=null)))});"rtl"==n&&(l.dir=n,l.style.left="auto",l.style.right="0");!k&&u&&(m=a.splitTextNodeIntoWordsRanges(u),k=m[m.length-1]);k&&(k.collapse(!1),p=a.currentChapter.cfiFromRange(k),b[b.length-1].end=p);b.length||(l=this.doc.createRange(),l.selectNodeContents(c),l.collapse(!0),l=a.currentChapter.cfiFromRange(l),n=this.doc.createRange(),n.selectNodeContents(c),n.collapse(!1),c=a.currentChapter.cfiFromRange(n),b.push({start:l,end:c}));k=null;m=void 0;c=n=l=null;return b};
EPUBJS.Renderer.prototype.indexOfBreakableChar=function(a,b){for(b||(b=0);b<a.length;b++)if(-1!="- \t\r\n\b\f".indexOf(a.charAt(b)))return b;return-1};
EPUBJS.Renderer.prototype.splitTextNodeIntoWordsRanges=function(a){var b=[],c=a.textContent.trim(),d,e=this.indexOfBreakableChar(c);if(-1===e)return d=this.doc.createRange(),d.selectNodeContents(a),[d];d=this.doc.createRange();d.setStart(a,0);d.setEnd(a,e);b.push(d);d=this.doc.createRange();for(d.setStart(a,e+1);-1!=e;)e=this.indexOfBreakableChar(c,e+1),0<e&&(d&&(d.setEnd(a,e),b.push(d)),d=this.doc.createRange(),d.setStart(a,e+1));d&&(d.setEnd(a,c.length),b.push(d));return b};
EPUBJS.Renderer.prototype.rangePosition=function(a){a=a.getClientRects();return a.length?a=a[0]:null};EPUBJS.Renderer.prototype.getPageCfi=function(){return this.pageMap[2*this.chapterPos-1].start};
EPUBJS.Renderer.prototype.getRange=function(a,b,c){var d=this.doc.createRange();c=!0;"undefined"===typeof document.caretPositionFromPoint||c?"undefined"===typeof document.caretRangeFromPoint||c?(this.visibileEl=this.findElementAfter(a,b),d.setStart(this.visibileEl,1)):d=this.doc.caretRangeFromPoint(a,b):(a=this.doc.caretPositionFromPoint(a,b),d.setStart(a.offsetNode,a.offset));return d};
EPUBJS.Renderer.prototype.pagesInCurrentChapter=function(){var a;if(!this.pageMap)return console.warn("page map not loaded"),!1;a=this.pageMap.length;return this.spreads?Math.ceil(a/2):a};EPUBJS.Renderer.prototype.currentRenderedPage=function(){return this.pageMap?this.spreads&&1<this.pageMap.length?2*this.chapterPos:this.chapterPos:(console.warn("page map not loaded"),!1)};
EPUBJS.Renderer.prototype.getRenderedPagesLeft=function(){return this.pageMap?this.pageMap.length-(this.spreads?2*this.chapterPos:this.chapterPos):(console.warn("page map not loaded"),!1)};
EPUBJS.Renderer.prototype.getVisibleRangeCfi=function(){var a,b,c;if(!this.pageMap)return console.warn("page map not loaded"),!1;this.spreads?(a=2*this.chapterPos,c=b=this.pageMap[a-2],1<this.pageMap.length&&this.pageMap.length>a-1&&(c=this.pageMap[a-1])):(a=this.chapterPos,c=b=this.pageMap[a-1]);b||(console.warn("page range miss:",a,this.pageMap),c=b=this.pageMap[this.pageMap.length-1]);return{start:b.start,end:c.end}};
EPUBJS.Renderer.prototype.gotoCfi=function(a){var b,c;if(this._moving)return this._q.enqueue("gotoCfi",arguments);EPUBJS.core.isString(a)&&(a=this.epubcfi.parse(a));if("undefined"===typeof document.evaluate){if(c=this.epubcfi.addMarker(a,this.doc))b=this.render.getPageNumberByElement(c),this.epubcfi.removeMarker(c,this.doc),this.page(b)}else(b=this.epubcfi.generateRangeFromCfi(a,this.doc))?(b=(b=b.getBoundingClientRect())?this.render.getPageNumberByRect(b):1,this.page(b),this.currentLocationCfi=a.str):
this.page(1)};EPUBJS.Renderer.prototype.findFirstVisible=function(a){var b=a||this.render.getBaseElement();return(b=this.walk(b,0,0))?b:a};EPUBJS.Renderer.prototype.findElementAfter=function(a,b,c){c=c||this.render.getBaseElement();return(a=this.walk(c,a,b))?a:c};EPUBJS.Renderer.prototype.resize=function(a,b,c){this.width=a;this.height=b;!1!==c&&this.render.resize(this.width,this.height);this.contents&&this.reformat();this.trigger("renderer:resized",{width:this.width,height:this.height})};
EPUBJS.Renderer.prototype.onResized=function(a){this.resize(this.container.clientWidth,this.container.clientHeight,!1)};EPUBJS.Renderer.prototype.addEventListeners=function(){this.render.document&&this.listenedEvents.forEach(function(a){this.render.document.addEventListener(a,this.triggerEvent.bind(this),!1)},this)};
EPUBJS.Renderer.prototype.removeEventListeners=function(){this.render.document&&this.listenedEvents.forEach(function(a){this.render.document.removeEventListener(a,this.triggerEvent,!1)},this)};EPUBJS.Renderer.prototype.triggerEvent=function(a){this.trigger("renderer:"+a.type,a)};EPUBJS.Renderer.prototype.addSelectionListeners=function(){this.render.document.addEventListener("selectionchange",this.onSelectionChange.bind(this),!1)};
EPUBJS.Renderer.prototype.removeSelectionListeners=function(){this.render.document&&this.doc.removeEventListener("selectionchange",this.onSelectionChange,!1)};EPUBJS.Renderer.prototype.onSelectionChange=function(a){this.selectionEndTimeout&&clearTimeout(this.selectionEndTimeout);this.selectionEndTimeout=setTimeout(function(){this.selectedRange=this.render.window.getSelection();this.trigger("renderer:selected",this.selectedRange)}.bind(this),500)};
EPUBJS.Renderer.prototype.setMinSpreadWidth=function(a){this.minSpreadWidth=a;this.spreads=this.determineSpreads(a)};EPUBJS.Renderer.prototype.determineSpreads=function(a){return this.isForcedSingle||!a||this.width<a?!1:!0};EPUBJS.Renderer.prototype.forceSingle=function(a){this.isForcedSingle=a?!0:!1};EPUBJS.Renderer.prototype.setGap=function(a){this.gap=a};EPUBJS.Renderer.prototype.setDirection=function(a){this.direction=a;this.render.setDirection(this.direction)};
EPUBJS.Renderer.prototype.replace=function(a,b,c,d){a=this.contents.querySelectorAll(a);a=Array.prototype.slice.call(a);var e=a.length;0===e?c(!1):a.forEach(function(a){var f=!1;b(a,function(a,b){!1===f&&(e--,d&&d(a,b,e),0>=e&&c&&c(!0),f=!0)})}.bind(this))};RSVP.EventTarget.mixin(EPUBJS.Renderer.prototype);EPUBJS=EPUBJS||{};EPUBJS.replace={};
EPUBJS.replace.hrefs=function(a,b){var c=this;b.replace("a[href]",function(a,e){var d=a.getAttribute("href"),g,h,k;-1!=d.search("://")?a.setAttribute("target","_blank"):(g=b.render.docEl.querySelector("base"),g=g.getAttribute("href"),k=EPUBJS.core.uri(g),h=(g=k.directory)?"file"===k.protocol?EPUBJS.core.resolveUrl(k.base,d):EPUBJS.core.resolveUrl(g,d):d,a.onclick=function(){c.goto(h);return!1});e()},a)};
EPUBJS.replace.head=function(a,b){b.replaceWithStored("link[href]","href",EPUBJS.replace.links,a)};EPUBJS.replace.resources=function(a,b){b.replaceWithStored("[src]","src",EPUBJS.replace.srcs,a)};EPUBJS.replace.svg=function(a,b){b.replaceWithStored("svg image","xlink:href",function(a,b,e){a.getUrl(b).then(e)},a)};EPUBJS.replace.srcs=function(a,b,c){a.getUrl(b).then(c)};
EPUBJS.replace.links=function(a,b,c,d){"stylesheet"===d.getAttribute("rel")?EPUBJS.replace.stylesheets(a,b).then(function(a,b){c(a,b)},function(a){c(null)}):a.getUrl(b).then(c,function(a){c(null)})};
EPUBJS.replace.stylesheets=function(a,b){var c=new RSVP.defer;if(a)return a.getText(b).then(function(d){EPUBJS.replace.cssUrls(a,b,d).then(function(a){var b=window.URL||window.webkitURL||window.mozURL;a=new Blob([a],{type:"text/css"});b=b.createObjectURL(a);c.resolve(b)},function(a){c.reject(a)})},function(a){c.reject(a)}),c.promise};
EPUBJS.replace.cssUrls=function(a,b,c){var d=new RSVP.defer,e=[],f=c.match(/url\(\'?\"?((?!data:)[^\'|^\"^\)]*)\'?\"?\)/g);if(a){if(!f)return d.resolve(c),d.promise;f.forEach(function(f){var g=EPUBJS.core.resolveUrl(b,f.replace(/url\(|[|\)|\'|\"]|\?.*$/g,"")),g=a.getUrl(g).then(function(a){c=c.replace(f,'url("'+a+'")')},function(a){d.reject(a)});e.push(g)});RSVP.all(e).then(function(){d.resolve(c)});return d.promise}};
EPUBJS.Storage=function(a){this.checkRequirements();this.urlCache={};this.withCredentials=a;this.URL=window.URL||window.webkitURL||window.mozURL;this.offline=!1};EPUBJS.Storage.prototype.checkRequirements=function(a){"undefined"==typeof localforage&&console.error("localForage library not loaded")};
EPUBJS.Storage.prototype.put=function(a,b){var c=new RSVP.defer,d=a.length,e=0,f=function(b){var c=b||new RSVP.defer,g;e>=d?c.resolve():(b=a[e].url,g=window.encodeURIComponent(b),EPUBJS.core.request(b,"binary").then(function(a){return localforage.setItem(g,a)}).then(function(a){e++;setTimeout(function(){f(c)},1)}));return c.promise}.bind(this);Array.isArray(a)||(a=[a]);f().then(function(){c.resolve()}.bind(this));return c.promise};
EPUBJS.Storage.prototype.token=function(a,b){a=window.encodeURIComponent(a);return localforage.setItem(a,b).then(function(a){return null===a?!1:!0})};EPUBJS.Storage.prototype.isStored=function(a){a=window.encodeURIComponent(a);return localforage.getItem(a).then(function(a){return null===a?!1:!0})};
EPUBJS.Storage.prototype.getText=function(a){var b=window.encodeURIComponent(a);return EPUBJS.core.request(a,"arraybuffer",this.withCredentials).then(function(a){this.offline&&(this.offline=!1,this.trigger("offline",!1));localforage.setItem(b,a);return a}.bind(this)).then(function(b){var c=new RSVP.defer,e=EPUBJS.core.getMimeType(a);b=new Blob([b],{type:e});var f=new FileReader;f.addEventListener("loadend",function(){c.resolve(f.result)});f.readAsText(b,e);return c.promise}).catch(function(){var c=
new RSVP.defer,d=localforage.getItem(b);this.offline||(this.offline=!0,this.trigger("offline",!0));if(!d)return c.reject({message:"File not found in the storage: "+a,stack:Error().stack}),c.promise;d.then(function(b){var d=EPUBJS.core.getMimeType(a);b=new Blob([b],{type:d});var e=new FileReader;e.addEventListener("loadend",function(){c.resolve(e.result)});e.readAsText(b,d)});return c.promise}.bind(this))};
EPUBJS.Storage.prototype.getUrl=function(a){var b=window.encodeURIComponent(a);return EPUBJS.core.request(a,"arraybuffer",this.withCredentials).then(function(c){this.offline&&(this.offline=!1,this.trigger("offline",!1));localforage.setItem(b,c);return a}.bind(this)).catch(function(){var c=new RSVP.defer,d,e=window.URL||window.webkitURL||window.mozURL,f;this.offline||(this.offline=!0,this.trigger("offline",!0));if(b in this.urlCache)return c.resolve(this.urlCache[b]),c.promise;d=localforage.getItem(b);
if(!d)return c.reject({message:"File not found in the storage: "+a,stack:Error().stack}),c.promise;d.then(function(d){d=new Blob([d],{type:EPUBJS.core.getMimeType(a)});f=e.createObjectURL(d);c.resolve(f);this.urlCache[b]=f}.bind(this));return c.promise}.bind(this))};
EPUBJS.Storage.prototype.getXml=function(a){var b=window.encodeURIComponent(a);return EPUBJS.core.request(a,"arraybuffer",this.withCredentials).then(function(a){this.offline&&(this.offline=!1,this.trigger("offline",!1));localforage.setItem(b,a);return a}.bind(this)).then(function(b){var c=new RSVP.defer,e=EPUBJS.core.getMimeType(a);b=new Blob([b],{type:e});var f=new FileReader;f.addEventListener("loadend",function(){var a=(new DOMParser).parseFromString(f.result,"text/xml");c.resolve(a)});f.readAsText(b,
e);return c.promise}).catch(function(){var c=new RSVP.defer,d=localforage.getItem(b);this.offline||(this.offline=!0,this.trigger("offline",!0));if(!d)return c.reject({message:"File not found in the storage: "+a,stack:Error().stack}),c.promise;d.then(function(b){var d=EPUBJS.core.getMimeType(a);b=new Blob([b],{type:d});var e=new FileReader;e.addEventListener("loadend",function(){var a=(new DOMParser).parseFromString(e.result,"text/xml");c.resolve(a)});e.readAsText(b,d)});return c.promise}.bind(this))};
EPUBJS.Storage.prototype.revokeUrl=function(a){var b=window.URL||window.webkitURL||window.mozURL;(a=this.urlCache[a])&&b.revokeObjectURL(a)};EPUBJS.Storage.prototype.failed=function(a){console.error(a)};RSVP.EventTarget.mixin(EPUBJS.Storage.prototype);EPUBJS.Unarchiver=function(a){this.checkRequirements();this.urlCache={}};EPUBJS.Unarchiver.prototype.checkRequirements=function(a){"undefined"==typeof JSZip&&console.error("JSZip lib not loaded")};
EPUBJS.Unarchiver.prototype.open=function(a,b){return a instanceof ArrayBuffer?(this.zip=new JSZip(a),a=new RSVP.defer,a.resolve(),a.promise):EPUBJS.core.request(a,"binary").then(function(a){this.zip=new JSZip(a)}.bind(this))};EPUBJS.Unarchiver.prototype.getXml=function(a,b){var c=window.decodeURIComponent(a);return this.getText(c,b).then(function(b){var c=new DOMParser,d=EPUBJS.core.getMimeType(a);return c.parseFromString(b,d)})};
EPUBJS.Unarchiver.prototype.getUrl=function(a,b){b=new RSVP.defer;var c=window.decodeURIComponent(a),d=this.zip.file(c),c=window.URL||window.webkitURL||window.mozURL;if(!d)return b.reject({message:"File not found in the epub: "+a,stack:Error().stack}),b.promise;if(a in this.urlCache)return b.resolve(this.urlCache[a]),b.promise;d=new Blob([d.asUint8Array()],{type:EPUBJS.core.getMimeType(d.name)});c=c.createObjectURL(d);b.resolve(c);this.urlCache[a]=c;return b.promise};
EPUBJS.Unarchiver.prototype.getText=function(a,b){b=new RSVP.defer;var c=window.decodeURIComponent(a),c=this.zip.file(c);if(!c)return b.reject({message:"File not found in the epub: "+a,stack:Error().stack}),b.promise;a=c.asText();b.resolve(a);return b.promise};EPUBJS.Unarchiver.prototype.revokeUrl=function(a){var b=window.URL||window.webkitURL||window.mozURL;(a=this.urlCache[a])&&b.revokeObjectURL(a)};EPUBJS.Unarchiver.prototype.failed=function(a){console.error(a)};
EPUBJS.Unarchiver.prototype.afterSaved=function(a){this.callback()};EPUBJS.Unarchiver.prototype.toStorage=function(a){function b(){e--;0===e&&d.afterSaved()}var c=0,d=this,e=a.length;a.forEach(function(a){setTimeout(function(a){d.saveEntryFileToStorage(a,b)},c,a);c+=20});console.log("time",c)};
(function(){var a={application:{ecmascript:["es","ecma"],javascript:"js",ogg:"ogx",pdf:"pdf",postscript:"ps ai eps epsi epsf eps2 eps3".split(" "),"rdf+xml":"rdf",smil:["smi","smil"],"xhtml+xml":["xhtml","xht"],xml:["xml","xsl","xsd","opf","ncx"],zip:"zip","x-httpd-eruby":"rhtml","x-latex":"latex","x-maker":"frm maker frame fm fb book fbdoc".split(" "),"x-object":"o","x-shockwave-flash":["swf","swfl"],"x-silverlight":"scr","epub+zip":"epub","font-tdpfr":"pfr","inkml+xml":["ink","inkml"],json:"json",
"jsonml+json":"jsonml","mathml+xml":"mathml","metalink+xml":"metalink",mp4:"mp4s","omdoc+xml":"omdoc",oxps:"oxps","vnd.amazon.ebook":"azw",widget:"wgt","x-dtbook+xml":"dtb","x-dtbresource+xml":"res","x-font-bdf":"bdf","x-font-ghostscript":"gsf","x-font-linux-psf":"psf","x-font-otf":"otf","x-font-pcf":"pcf","x-font-snf":"snf","x-font-ttf":["ttf","ttc"],"x-font-type1":["pfa","pfb","pfm","afm"],"x-font-woff":"woff","x-mobipocket-ebook":["prc","mobi"],"x-mspublisher":"pub","x-nzb":"nzb","x-tgif":"obj",
"xaml+xml":"xaml","xml-dtd":"dtd","xproc+xml":"xpl","xslt+xml":"xslt","internet-property-stream":"acx","x-compress":"z","x-compressed":"tgz","x-gzip":"gz"},audio:{flac:"flac",midi:["mid","midi","kar","rmi"],mpeg:"mpga mpega mp2 mp3 m4a mp2a m2a m3a".split(" "),mpegurl:"m3u",ogg:["oga","ogg","spx"],"x-aiff":["aif","aiff","aifc"],"x-ms-wma":"wma","x-wav":"wav",adpcm:"adp",mp4:"mp4a",webm:"weba","x-aac":"aac","x-caf":"caf","x-matroska":"mka","x-pn-realaudio-plugin":"rmp",xm:"xm",mid:["mid","rmi"]},image:{gif:"gif",
ief:"ief",jpeg:["jpeg","jpg","jpe"],pcx:"pcx",png:"png","svg+xml":["svg","svgz"],tiff:["tiff","tif"],"x-icon":"ico",bmp:"bmp",webp:"webp","x-pict":["pic","pct"],"x-tga":"tga","cis-cod":"cod"},message:{rfc822:["eml","mime","mht","mhtml","nws"]},text:{"cache-manifest":["manifest","appcache"],calendar:["ics","icz","ifb"],css:"css",csv:"csv",h323:"323",html:["html","htm","shtml","stm"],iuls:"uls",mathml:"mml",plain:"txt text brf conf def list log in bas".split(" "),richtext:"rtx","tab-separated-values":"tsv",
"x-bibtex":"bib","x-dsrc":"d","x-diff":["diff","patch"],"x-haskell":"hs","x-java":"java","x-literate-haskell":"lhs","x-moc":"moc","x-pascal":["p","pas"],"x-pcs-gcd":"gcd","x-perl":["pl","pm"],"x-python":"py","x-scala":"scala","x-setext":"etx","x-tcl":["tcl","tk"],"x-tex":["tex","ltx","sty","cls"],"x-vcard":"vcf",sgml:["sgml","sgm"],"x-c":"c cc cxx cpp h hh dic".split(" "),"x-fortran":["f","for","f77","f90"],"x-opml":"opml","x-nfo":"nfo","x-sfv":"sfv","x-uuencode":"uu",webviewhtml:"htt"},video:{mpeg:"mpeg mpg mpe m1v m2v mp2 mpa mpv2".split(" "),
mp4:["mp4","mp4v","mpg4"],quicktime:["qt","mov"],ogg:"ogv","vnd.mpegurl":["mxu","m4u"],"x-flv":"flv","x-la-asf":["lsf","lsx"],"x-mng":"mng","x-ms-asf":["asf","asx","asr"],"x-ms-wm":"wm","x-ms-wmv":"wmv","x-ms-wmx":"wmx","x-ms-wvx":"wvx","x-msvideo":"avi","x-sgi-movie":"movie","x-matroska":["mpv","mkv","mk3d","mks"],"3gpp2":"3g2",h261:"h261",h263:"h263",h264:"h264",jpeg:"jpgv",jpm:["jpm","jpgm"],mj2:["mj2","mjp2"],"vnd.ms-playready.media.pyv":"pyv","vnd.uvvu.mp4":["uvu","uvvu"],"vnd.vivo":"viv",webm:"webm",
"x-f4v":"f4v","x-m4v":"m4v","x-ms-vob":"vob","x-smv":"smv"}},b=function(){var b,d,e,f,g={};for(b in a)if(a.hasOwnProperty(b))for(d in a[b])if(a[b].hasOwnProperty(d))if(e=a[b][d],"string"==typeof e)g[e]=b+"/"+d;else for(f=0;f<e.length;f++)g[e[f]]=b+"/"+d;return g}();EPUBJS.core.getMimeType=function(a){return a&&b[a.split(".").pop().toLowerCase()]||"text/plain"}})();